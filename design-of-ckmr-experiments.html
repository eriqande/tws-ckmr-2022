<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Session 3 Design of CKMR Experiments | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA</title>
  <meta name="description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Session 3 Design of CKMR Experiments | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="github-repo" content="yihui/bookdown-crc" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Session 3 Design of CKMR Experiments | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA" />
  
  <meta name="twitter:description" content="A book example for a Chapman &amp; Hall book." />
  

<meta name="author" content="Paul B. Conn and Eric C. Anderson" />


<meta name="date" content="2022-10-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block/empty-anchor.js"></script>
<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">TWS-CKMR-2022</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Course Overview</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#workshop-schedule"><i class="fa fa-check"></i>Workshop schedule</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#resources"><i class="fa fa-check"></i>Resources</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#setting-computer"><i class="fa fa-check"></i>Setting up your computer</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#step-1.-install-recent-versions-of-r-and-rstudio"><i class="fa fa-check"></i>Step 1. Install recent versions of R and RStudio</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#step-2.-make-sure-that-you-have-git-installed-on-your-system"><i class="fa fa-check"></i>Step 2. Make sure that you have <code>git</code> installed on your system</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#step-3.-get-the-workshop-materials-from-github-with-rstudio"><i class="fa fa-check"></i>Step 3. Get the workshop materials from GitHub with RStudio</a></li>
</ul></li>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#a-word-about-the-renv-package"><i class="fa fa-check"></i><b>0.1</b> A word about the ‘renv’ package</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#a-word-about-the-tmb-package"><i class="fa fa-check"></i><b>0.2</b> A word about the TMB package</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html"><i class="fa fa-check"></i><b>1</b> CKMR thought experiments and labs</a><ul>
<li class="chapter" data-level="1.1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#afternoon-schedule"><i class="fa fa-check"></i><b>1.1</b> Afternoon schedule</a></li>
<li class="chapter" data-level="1.2" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#thought-experiments"><i class="fa fa-check"></i><b>1.2</b> Thought experiments</a><ul>
<li class="chapter" data-level="1.2.1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#thought-experiment-1"><i class="fa fa-check"></i><b>1.2.1</b> Thought experiment 1</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><i class="fa fa-check"></i><b>2</b> Simulation and Inference Play with Hillary et al.’s White Shark CKMR example</a><ul>
<li class="chapter" data-level="2.1" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#simulating-from-their-inferential-model"><i class="fa fa-check"></i><b>2.1</b> Simulating from their inferential model</a></li>
<li class="chapter" data-level="2.2" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#an-r-function-to-compute-the-negative-log-likelihood"><i class="fa fa-check"></i><b>2.2</b> An R function to compute the negative log-likelihood</a></li>
<li class="chapter" data-level="2.3" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#evaluate-the-likelihood-with-tmb"><i class="fa fa-check"></i><b>2.3</b> Evaluate the likelihood with TMB</a></li>
<li class="chapter" data-level="2.4" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#visualize-those-log-likelihood-values"><i class="fa fa-check"></i><b>2.4</b> Visualize those log likelihood values</a></li>
<li class="chapter" data-level="2.5" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#omg-lets-investigate-the-tmbstan-package"><i class="fa fa-check"></i><b>2.5</b> OMG! Let’s investigate the tmbstan package!</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html"><i class="fa fa-check"></i><b>3</b> Design of CKMR Experiments</a><ul>
<li class="chapter" data-level="3.1" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#white-shark-design-example"><i class="fa fa-check"></i><b>3.1</b> White shark design example</a><ul>
<li class="chapter" data-level="3.1.1" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#fisher-information-ideas"><i class="fa fa-check"></i><b>3.1.1</b> Fisher information ideas</a></li>
<li class="chapter" data-level="3.1.2" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#calculating-expected-data-under-different-design-scenarios"><i class="fa fa-check"></i><b>3.1.2</b> Calculating expected data under different design scenarios</a></li>
<li class="chapter" data-level="3.1.3" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#calculating-expected-variance-under-different-design-scenarios"><i class="fa fa-check"></i><b>3.1.3</b> Calculating expected variance under different design scenarios</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#bearded-seal-simulation-study"><i class="fa fa-check"></i><b>3.2</b> Bearded seal simulation study</a><ul>
<li class="chapter" data-level="3.2.1" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#setting-up-simulations-population-dynamics"><i class="fa fa-check"></i><b>3.2.1</b> Setting up simulations: Population dynamics</a></li>
<li class="chapter" data-level="3.2.2" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#setting-up-simulations-ckmrpop"><i class="fa fa-check"></i><b>3.2.2</b> Setting up simulations: CKMRpop</a></li>
<li class="chapter" data-level="3.2.3" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#formatting-data-for-estimation"><i class="fa fa-check"></i><b>3.2.3</b> Formatting data for estimation</a></li>
<li class="chapter" data-level="3.2.4" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#fitting-the-ckmr-model"><i class="fa fa-check"></i><b>3.2.4</b> Fitting the CKMR model</a></li>
<li class="chapter" data-level="3.2.5" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#thought-experiment"><i class="fa fa-check"></i><b>3.2.5</b> Thought experiment</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Close-kin mark-recapture: theory and practice — Spokane, Washington, USA</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="design-of-ckmr-experiments" class="section level1 hasAnchor">
<h1><span class="header-section-number">Session 3</span> Design of CKMR Experiments<a href="design-of-ckmr-experiments.html#design-of-ckmr-experiments" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this lab, we’ll look at various tools to help design CKMR experiments. We’re relatively liberal with what we call a “design” tool. It could be optimizing
sample allocation to achieve maximum precision for a given parameter (e.g., which sexes and ages to target), or it could simply be examining the effect of different
types of assumption violations on estimator performance. After all, if a particular type of model is likely to lead to highly biased parameter estimates, it is probably best to adapt model structure, or to leave out certain types of kin comparisons
that are likely to violate assumptions.</p>
<p>We’ll consider two specific examples: (1) optimizing sample allocation in <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> white shark example, and (2) conducting individual-based
simulation to investigate impacts of assumption violations in CKMR models for bearded seals.</p>
<div id="white-shark-design-example" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.1</span> White shark design example<a href="design-of-ckmr-experiments.html#white-shark-design-example" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In a previous lab, we looked at <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> model using cross-cohort comparisons of half siblings caught as juveniles. We might look at a few things with this example, such as how we would partition samples across years and ages if we had the ability to do so. Presumably, the optimal allocation would depend on the parameter
we were interested in (e.g., population growth (<span class="math inline">\(\lambda\)</span>), adult survival (<span class="math inline">\(S\)</span>) or
terminal year abundance (call this <span class="math inline">\(N_T\)</span>). Both <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(S\)</span> are parameters of the CKMR model, but <span class="math inline">\(N_T\)</span> is a derived parameter (that is, a <em>function</em> of parameters) and can be computed as</p>
<p><span class="math display">\[\begin{equation*}
  N_T = N_0 * \exp(\lambda  T) 
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(T\)</span> is the number of years in the study.</p>
<div id="fisher-information-ideas" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.1.1</span> Fisher information ideas<a href="design-of-ckmr-experiments.html#fisher-information-ideas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’ll be using Fisher information ideas to compare anticipated precision
associated with various white shark sampling designs. As articulated in the
slides on design for this workshop, this involves a number of steps:</p>
<ol style="list-style-type: decimal">
<li><p>Allocate potential sample sizes to particular years, ages, sexes, etc. (basically the different covariates one is modeling). These can be expectations (fractions)!</p></li>
<li><p>Compute sufficient statistics (expected # of comparisons and number of matches for each covariate combination)</p></li>
<li><p>Treating these as data, calculate second derivatives of the negative log-pseudo-likelihood at the true parameter values</p></li>
<li><p>Calculate the expected variance-covariance matrix of parameters in the usual way (inverse of the numeric Fisher information matrix)</p></li>
<li><p>Calculate expected variance of any functions of parameters using the delta method</p></li>
<li><p>Compare precision (e.g. CV) associated with different designs!!</p></li>
</ol>
<p>Fortunately, we already have the infrastructure set up to help us the negative log-pseudo-likelihood (both in R and TMB). We <em>could</em> use numerical second derivatives (e.g., using the <span class="math inline">\(numDeriv\)</span> package in R) and
not even have to deal with minimizing the NLPL, but Template Model Builder is well set up to produce numerical variance-covariance matrices (including functions of parameters), so why don’t we just follow the path of least resistance and fit our model using TMB. We’ll still need
to formulate some alternative designs and what the expected data would look like under each.</p>
</div>
<div id="calculating-expected-data-under-different-design-scenarios" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.1.2</span> Calculating expected data under different design scenarios<a href="design-of-ckmr-experiments.html#calculating-expected-data-under-different-design-scenarios" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s set up “true” population dynamics to consist of a stable population with 1000 adults
which we assume to be constant over a 20 year period. We’ll set the assume a constant adult survival probability of 0.94, and that sampling occurs over the last 10 years of the time interval. We’ll assume that sampling targets juveniles (ages 3-8) only, so the most we’ll have to go back in time is 8 years (which is why the model needs to go back further in time than just the years that are sampled!!).</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="design-of-ckmr-experiments.html#cb45-1"></a>Ninit =<span class="st"> </span><span class="dv">1000</span> </span>
<span id="cb45-2"><a href="design-of-ckmr-experiments.html#cb45-2"></a>lambda =<span class="st"> </span><span class="fl">0.0</span></span>
<span id="cb45-3"><a href="design-of-ckmr-experiments.html#cb45-3"></a>n_yrs =<span class="st"> </span><span class="dv">20</span></span>
<span id="cb45-4"><a href="design-of-ckmr-experiments.html#cb45-4"></a>N =<span class="st"> </span><span class="kw">matrix</span>(Ninit,<span class="dv">20</span>)</span>
<span id="cb45-5"><a href="design-of-ckmr-experiments.html#cb45-5"></a>phiA =<span class="st"> </span><span class="fl">0.94</span></span>
<span id="cb45-6"><a href="design-of-ckmr-experiments.html#cb45-6"></a>ylo=<span class="dv">11</span></span>
<span id="cb45-7"><a href="design-of-ckmr-experiments.html#cb45-7"></a>yhi=<span class="dv">20</span></span>
<span id="cb45-8"><a href="design-of-ckmr-experiments.html#cb45-8"></a>ages =<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">8</span>)  <span class="co">#only 3 - 8 yrs olds sampled</span></span>
<span id="cb45-9"><a href="design-of-ckmr-experiments.html#cb45-9"></a></span>
<span id="cb45-10"><a href="design-of-ckmr-experiments.html#cb45-10"></a><span class="co">#&#39; Function to calculate # of expected pairs given true adult abundance, adult</span></span>
<span id="cb45-11"><a href="design-of-ckmr-experiments.html#cb45-11"></a><span class="co">#&#39; survival, and # of juvenile white sharks sampled per year (males and female parents modeled together!)</span></span>
<span id="cb45-12"><a href="design-of-ckmr-experiments.html#cb45-12"></a><span class="co">#&#39; @param Npy vector of number of sharks to sample each year (num per year)</span></span>
<span id="cb45-13"><a href="design-of-ckmr-experiments.html#cb45-13"></a><span class="co">#&#39; @param ages a vector of the ages at which individuals are sampled</span></span>
<span id="cb45-14"><a href="design-of-ckmr-experiments.html#cb45-14"></a><span class="co">#&#39; @param age_wts vector of expected proportion of each age in the sample</span></span>
<span id="cb45-15"><a href="design-of-ckmr-experiments.html#cb45-15"></a><span class="co">#&#39; @param N Vector of number of adults per year</span></span>
<span id="cb45-16"><a href="design-of-ckmr-experiments.html#cb45-16"></a><span class="co">#&#39; @param phiA Adult annual survival probability</span></span>
<span id="cb45-17"><a href="design-of-ckmr-experiments.html#cb45-17"></a><span class="co">#&#39; @return This returns two upper triangular matrices `M` and `EC`, both of which have dimension </span></span>
<span id="cb45-18"><a href="design-of-ckmr-experiments.html#cb45-18"></a><span class="co">#&#39; (n_yrs x #&#39; n_yrs).  The M matrix holds the number of comparisons where the row indexes the </span></span>
<span id="cb45-19"><a href="design-of-ckmr-experiments.html#cb45-19"></a><span class="co">#&#39; birth year of the older #&#39; half-sib, and the column gives the birth year of the younger </span></span>
<span id="cb45-20"><a href="design-of-ckmr-experiments.html#cb45-20"></a><span class="co">#&#39; half sib.  The EC matrix is organized the same way, but holds the expected half-sib count </span></span>
<span id="cb45-21"><a href="design-of-ckmr-experiments.html#cb45-21"></a><span class="co">#&#39; (i.e. # of matches)</span></span>
<span id="cb45-22"><a href="design-of-ckmr-experiments.html#cb45-22"></a>expected_data &lt;-<span class="st"> </span><span class="cf">function</span>(Npy,ylo,yhi,ages,age_wts,N,phiA){</span>
<span id="cb45-23"><a href="design-of-ckmr-experiments.html#cb45-23"></a>  age_wts =<span class="st"> </span>age_wts<span class="op">/</span><span class="kw">sum</span>(age_wts)  <span class="co">#normalize if not </span></span>
<span id="cb45-24"><a href="design-of-ckmr-experiments.html#cb45-24"></a>  n_ages =<span class="st"> </span><span class="kw">max</span>(ages)<span class="op">+</span><span class="dv">1</span> <span class="co">#nb this is just age 0 to the max of sampled age</span></span>
<span id="cb45-25"><a href="design-of-ckmr-experiments.html#cb45-25"></a>  age_prob =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,n_ages)</span>
<span id="cb45-26"><a href="design-of-ckmr-experiments.html#cb45-26"></a>  age_prob[ages<span class="op">+</span><span class="dv">1</span>]=age_wts<span class="op">/</span><span class="kw">sum</span>(age_wts)</span>
<span id="cb45-27"><a href="design-of-ckmr-experiments.html#cb45-27"></a>  n_yrs =<span class="st"> </span><span class="kw">length</span>(Npy)</span>
<span id="cb45-28"><a href="design-of-ckmr-experiments.html#cb45-28"></a>  M =<span class="st"> </span>EC =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,n_yrs,n_yrs)</span>
<span id="cb45-29"><a href="design-of-ckmr-experiments.html#cb45-29"></a>  </span>
<span id="cb45-30"><a href="design-of-ckmr-experiments.html#cb45-30"></a>  <span class="co"># expected number sampled by year and age</span></span>
<span id="cb45-31"><a href="design-of-ckmr-experiments.html#cb45-31"></a>  N_samp =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,n_yrs,<span class="kw">max</span>(ages)<span class="op">+</span><span class="dv">1</span>)  <span class="co">#this holds expected number sampled by year and age (w/ age 0)</span></span>
<span id="cb45-32"><a href="design-of-ckmr-experiments.html#cb45-32"></a>  <span class="cf">for</span>(iyr <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_yrs){</span>
<span id="cb45-33"><a href="design-of-ckmr-experiments.html#cb45-33"></a>    N_samp[iyr,]=Npy[iyr]<span class="op">*</span>age_prob</span>
<span id="cb45-34"><a href="design-of-ckmr-experiments.html#cb45-34"></a>  }</span>
<span id="cb45-35"><a href="design-of-ckmr-experiments.html#cb45-35"></a>  <span class="co"># convert to number sampled by birth year</span></span>
<span id="cb45-36"><a href="design-of-ckmr-experiments.html#cb45-36"></a>  N_samp_by =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,n_yrs)</span>
<span id="cb45-37"><a href="design-of-ckmr-experiments.html#cb45-37"></a>  <span class="cf">for</span>(iyr <span class="cf">in</span> <span class="dv">11</span><span class="op">:</span>n_yrs){   <span class="co">#this would need to be changed to make general - i.e., sampling occurred &lt; year 10</span></span>
<span id="cb45-38"><a href="design-of-ckmr-experiments.html#cb45-38"></a>    <span class="cf">for</span>(iage <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_ages){</span>
<span id="cb45-39"><a href="design-of-ckmr-experiments.html#cb45-39"></a>      N_samp_by[iyr<span class="op">-</span>iage<span class="op">+</span><span class="dv">1</span>]=N_samp_by[iyr<span class="op">-</span>iage<span class="op">+</span><span class="dv">1</span>]<span class="op">+</span>N_samp[iyr,iage]</span>
<span id="cb45-40"><a href="design-of-ckmr-experiments.html#cb45-40"></a>    }</span>
<span id="cb45-41"><a href="design-of-ckmr-experiments.html#cb45-41"></a>  }</span>
<span id="cb45-42"><a href="design-of-ckmr-experiments.html#cb45-42"></a>  </span>
<span id="cb45-43"><a href="design-of-ckmr-experiments.html#cb45-43"></a>  <span class="co">#Number of comparisons, probability of matches, expected number of matches</span></span>
<span id="cb45-44"><a href="design-of-ckmr-experiments.html#cb45-44"></a>  <span class="cf">for</span>(iyr <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n_yrs<span class="dv">-1</span>)){</span>
<span id="cb45-45"><a href="design-of-ckmr-experiments.html#cb45-45"></a>    <span class="cf">for</span>(iyr2 <span class="cf">in</span> (iyr<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>n_yrs){</span>
<span id="cb45-46"><a href="design-of-ckmr-experiments.html#cb45-46"></a>      M[iyr,iyr2]=N_samp_by[iyr]<span class="op">*</span>N_samp_by[iyr2]</span>
<span id="cb45-47"><a href="design-of-ckmr-experiments.html#cb45-47"></a>      age_diff =<span class="st"> </span>iyr2<span class="op">-</span>iyr</span>
<span id="cb45-48"><a href="design-of-ckmr-experiments.html#cb45-48"></a>      HSP_prob =<span class="st"> </span><span class="dv">4</span><span class="op">/</span>N[iyr]<span class="op">*</span>(phiA<span class="op">^</span>age_diff) <span class="co">#nb: there&#39;s some duplication here!</span></span>
<span id="cb45-49"><a href="design-of-ckmr-experiments.html#cb45-49"></a>      EC[iyr,iyr2]=M[iyr,iyr2]<span class="op">*</span>HSP_prob</span>
<span id="cb45-50"><a href="design-of-ckmr-experiments.html#cb45-50"></a>    }</span>
<span id="cb45-51"><a href="design-of-ckmr-experiments.html#cb45-51"></a>  }</span>
<span id="cb45-52"><a href="design-of-ckmr-experiments.html#cb45-52"></a>  </span>
<span id="cb45-53"><a href="design-of-ckmr-experiments.html#cb45-53"></a>  <span class="kw">list</span>(<span class="dt">EC=</span>EC,<span class="dt">M=</span>M)</span>
<span id="cb45-54"><a href="design-of-ckmr-experiments.html#cb45-54"></a>}</span></code></pre></div>
<p>Let’s looks at a few scenarios, including (1) sampling ages proportional to their approximate
abundance in the population, and (2) sampling ages biased towards younger age classes. We’ll sample
20 individuals per year, as might occur in a balanced monitoring program. We’ll generate an expected
number of comparisons and an expected count for each combination of birth years for half-sib comparisons
(omitting same-cohort comparisons).</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="design-of-ckmr-experiments.html#cb46-1"></a>Npy =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">20</span>)</span>
<span id="cb46-2"><a href="design-of-ckmr-experiments.html#cb46-2"></a>Npy[<span class="dv">11</span><span class="op">:</span><span class="dv">20</span>] =<span class="st"> </span><span class="dv">20</span> </span>
<span id="cb46-3"><a href="design-of-ckmr-experiments.html#cb46-3"></a><span class="co"># sampling proportional to what we&#39;d expect with a constant survival probability of 0.92</span></span>
<span id="cb46-4"><a href="design-of-ckmr-experiments.html#cb46-4"></a>age_wts_prop =<span class="st"> </span><span class="fl">0.92</span><span class="op">^</span><span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">5</span>) <span class="co">#since &quot;ages&quot; is 3:8, this needs to consist of 6 weights</span></span>
<span id="cb46-5"><a href="design-of-ckmr-experiments.html#cb46-5"></a>age_wts_young =<span class="st"> </span><span class="kw">c</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">1</span>)  <span class="co">#6 times more likely to sample &amp; genotype a 3 year old than an 8 year old</span></span>
<span id="cb46-6"><a href="design-of-ckmr-experiments.html#cb46-6"></a>Exp_data_prop =<span class="st"> </span><span class="kw">expected_data</span>(Npy,ylo,yhi,ages,<span class="dt">age_wts=</span>age_wts_prop,N,phiA)</span>
<span id="cb46-7"><a href="design-of-ckmr-experiments.html#cb46-7"></a>Exp_data_young =<span class="st"> </span><span class="kw">expected_data</span>(Npy,ylo,yhi,ages,<span class="dt">age_wts=</span>age_wts_young,N,phiA)</span></code></pre></div>
<p>One thing we can look at right away is the number of kin pairs for the two designs. For the design
with proportional age sampling the number of HSPs is 57.6215; for the design focusing
disproportionally on younger ages, we have 57.7955 HSPs. So, very close.</p>
</div>
<div id="calculating-expected-variance-under-different-design-scenarios" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.1.3</span> Calculating expected variance under different design scenarios<a href="design-of-ckmr-experiments.html#calculating-expected-variance-under-different-design-scenarios" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now let’s fit a “correct” model to these data - that is, one in which all assumptions are met. Note
that we don’t actually need to fit a model to do design calculations, but TMB computes variance estimates
and delta method approximations for functions of parameters, so we’ll sacrifice a tiny bit of time
estimating parameters in order to make our lives easier. If we were going to consider a large number of designs (or to do formal optimization of a design using quadratic programming or something) we’d want to revisit this
decision!! So, let’s compile a TMB model, fit a model to data, and look at estimated standard errors of
various quantities.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="design-of-ckmr-experiments.html#cb47-1"></a><span class="co"># compile TMB negative log pseudo-likeihood function</span></span>
<span id="cb47-2"><a href="design-of-ckmr-experiments.html#cb47-2"></a><span class="kw">library</span>(TMB)</span>
<span id="cb47-3"><a href="design-of-ckmr-experiments.html#cb47-3"></a><span class="kw">compile</span>(<span class="st">&quot;TMB/hsp_nll2.cpp&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="design-of-ckmr-experiments.html#cb49-1"></a><span class="co"># format data and specify starting values for parameters</span></span>
<span id="cb49-2"><a href="design-of-ckmr-experiments.html#cb49-2"></a>format_data &lt;-<span class="st"> </span><span class="cf">function</span>(M,EC){</span>
<span id="cb49-3"><a href="design-of-ckmr-experiments.html#cb49-3"></a>  Indices_gt0 =<span class="st"> </span><span class="kw">which</span>(M<span class="op">&gt;</span><span class="dv">0</span>,<span class="dt">arr.ind=</span><span class="ot">TRUE</span>)</span>
<span id="cb49-4"><a href="design-of-ckmr-experiments.html#cb49-4"></a>  Data =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb49-5"><a href="design-of-ckmr-experiments.html#cb49-5"></a>    <span class="dt">n_HSP =</span> EC[Indices_gt0],</span>
<span id="cb49-6"><a href="design-of-ckmr-experiments.html#cb49-6"></a>    <span class="dt">n_UP =</span> M[Indices_gt0]<span class="op">-</span>EC[Indices_gt0],</span>
<span id="cb49-7"><a href="design-of-ckmr-experiments.html#cb49-7"></a>    <span class="dt">born_year =</span> Indices_gt0[,<span class="dv">2</span>],  <span class="co">#for this HSP calc only need birth year of the *younger* animal</span></span>
<span id="cb49-8"><a href="design-of-ckmr-experiments.html#cb49-8"></a>    <span class="dt">age_diff =</span> Indices_gt0[,<span class="dv">2</span>]<span class="op">-</span>Indices_gt0[,<span class="dv">1</span>],</span>
<span id="cb49-9"><a href="design-of-ckmr-experiments.html#cb49-9"></a>    <span class="dt">present_year=</span> <span class="dv">20</span>  <span class="co">#terminal year for abundance estimate</span></span>
<span id="cb49-10"><a href="design-of-ckmr-experiments.html#cb49-10"></a>  )</span>
<span id="cb49-11"><a href="design-of-ckmr-experiments.html#cb49-11"></a>  Data</span>
<span id="cb49-12"><a href="design-of-ckmr-experiments.html#cb49-12"></a>}</span>
<span id="cb49-13"><a href="design-of-ckmr-experiments.html#cb49-13"></a></span>
<span id="cb49-14"><a href="design-of-ckmr-experiments.html#cb49-14"></a>Data_prop =<span class="st"> </span><span class="kw">format_data</span>(<span class="dt">M=</span>Exp_data_prop<span class="op">$</span>M,<span class="dt">EC=</span>Exp_data_prop<span class="op">$</span>EC)</span>
<span id="cb49-15"><a href="design-of-ckmr-experiments.html#cb49-15"></a>Data_young =<span class="st"> </span><span class="kw">format_data</span>(Exp_data_young<span class="op">$</span>M,Exp_data_young<span class="op">$</span>EC)</span>
<span id="cb49-16"><a href="design-of-ckmr-experiments.html#cb49-16"></a>  </span>
<span id="cb49-17"><a href="design-of-ckmr-experiments.html#cb49-17"></a>Parms =<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;N_init&quot;</span> =<span class="st"> </span><span class="dv">1000</span>, <span class="st">&quot;lambda&quot;</span>=<span class="fl">1.0</span>, <span class="dt">phiA=</span><span class="fl">0.94</span>)</span>
<span id="cb49-18"><a href="design-of-ckmr-experiments.html#cb49-18"></a></span>
<span id="cb49-19"><a href="design-of-ckmr-experiments.html#cb49-19"></a><span class="kw">dyn.load</span>(<span class="kw">dynlib</span>(<span class="st">&quot;TMB/hsp_nll2&quot;</span>))</span>
<span id="cb49-20"><a href="design-of-ckmr-experiments.html#cb49-20"></a>obj &lt;-<span class="st"> </span>TMB<span class="op">::</span><span class="kw">MakeADFun</span>(<span class="dt">data =</span> Data_prop, <span class="dt">parameters =</span> Parms, <span class="dt">DLL=</span><span class="st">&quot;hsp_nll2&quot;</span>)</span>
<span id="cb49-21"><a href="design-of-ckmr-experiments.html#cb49-21"></a>Opt =<span class="st"> </span><span class="kw">nlminb</span>(<span class="dt">start=</span>Parms, <span class="dt">objective=</span>obj<span class="op">$</span>fn, <span class="dt">gradient=</span>obj<span class="op">$</span>gr)</span></code></pre></div>
<pre><code>## outer mgc:  698.1</code></pre>
<pre><code>## Warning in nlminb(start = Parms, objective = obj$fn,
## gradient = obj$gr): NA/NaN function evaluation</code></pre>
<pre><code>## outer mgc:  852.9 
## outer mgc:  376.3 
## outer mgc:  156.6 
## outer mgc:  89.72 
## outer mgc:  4.769 
## outer mgc:  2.079 
## outer mgc:  0.04171 
## outer mgc:  0.03488 
## outer mgc:  0.002186 
## outer mgc:  0.0001492</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="design-of-ckmr-experiments.html#cb53-1"></a>SD_report_prop=<span class="kw">sdreport</span>(obj)</span></code></pre></div>
<pre><code>## outer mgc:  0.0001492 
## outer mgc:  0.0005512 
## outer mgc:  0.0008495 
## outer mgc:  8.839 
## outer mgc:  8.957 
## outer mgc:  2.981 
## outer mgc:  2.966 
## outer mgc:  20000</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="design-of-ckmr-experiments.html#cb55-1"></a>obj &lt;-<span class="st"> </span>TMB<span class="op">::</span><span class="kw">MakeADFun</span>(<span class="dt">data =</span> Data_young, <span class="dt">parameters =</span> Parms, <span class="dt">DLL=</span><span class="st">&quot;hsp_nll2&quot;</span>)</span>
<span id="cb55-2"><a href="design-of-ckmr-experiments.html#cb55-2"></a>Opt =<span class="st"> </span><span class="kw">nlminb</span>(<span class="dt">start=</span>Parms, <span class="dt">objective=</span>obj<span class="op">$</span>fn, <span class="dt">gradient=</span>obj<span class="op">$</span>gr)</span></code></pre></div>
<pre><code>## outer mgc:  732.1</code></pre>
<pre><code>## Warning in nlminb(start = Parms, objective = obj$fn,
## gradient = obj$gr): NA/NaN function evaluation</code></pre>
<pre><code>## outer mgc:  762.4 
## outer mgc:  364 
## outer mgc:  140.8 
## outer mgc:  73.41 
## outer mgc:  12.91 
## outer mgc:  24.74 
## outer mgc:  28.85 
## outer mgc:  1.88 
## outer mgc:  0.23 
## outer mgc:  0.01301 
## outer mgc:  0.0005072</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="design-of-ckmr-experiments.html#cb59-1"></a>SD_report_young=<span class="kw">sdreport</span>(obj)</span></code></pre></div>
<pre><code>## outer mgc:  0.0005072 
## outer mgc:  0.0002272 
## outer mgc:  0.001242 
## outer mgc:  9.619 
## outer mgc:  9.753 
## outer mgc:  3.035 
## outer mgc:  3.02 
## outer mgc:  20000</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="design-of-ckmr-experiments.html#cb61-1"></a><span class="co"># </span></span></code></pre></div>
<p>Okay, let’s see what TMB did for us. First let’s check that our estimates are truth - they should be
very close since we’re using expected values.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="design-of-ckmr-experiments.html#cb62-1"></a><span class="kw">print</span>(SD_report_prop<span class="op">$</span>value)</span></code></pre></div>
<pre><code>##     N_init     lambda       phiA     N_last 
##  1.000e+03 -1.864e-08  9.400e-01  1.000e+03</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="design-of-ckmr-experiments.html#cb64-1"></a><span class="kw">print</span>(SD_report_young<span class="op">$</span>value)</span></code></pre></div>
<pre><code>##     N_init     lambda       phiA     N_last 
##  1.000e+03 -3.057e-08  9.400e-01  1.000e+03</code></pre>
<p>Well that’s reassuring! How about standard errors?</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="design-of-ckmr-experiments.html#cb66-1"></a><span class="kw">print</span>(SD_report_prop<span class="op">$</span>sd)</span></code></pre></div>
<pre><code>## [1] 616.47723   0.05528   0.05620 588.11186</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="design-of-ckmr-experiments.html#cb68-1"></a><span class="kw">print</span>(SD_report_young<span class="op">$</span>sd)</span></code></pre></div>
<pre><code>## [1] 667.27825   0.05704   0.05757 570.87206</code></pre>
<p>So there is not much difference in estimator performance when sampling focuses on the youngest juvenile white sharks. Precision on <span class="math inline">\(\lambda\)</span> and survival is slightly better when we sample the full age range, while precision on terminal year abundance is slightly better when disproportionately focusing on very young white sharks.</p>
<p>Although differences weren’t very large here, hopefully you can see how such an analysis might be used to get at “the most bang for your buck” when trying to design a CKMR monitoring program.</p>
</div>
</div>
<div id="bearded-seal-simulation-study" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.2</span> Bearded seal simulation study<a href="design-of-ckmr-experiments.html#bearded-seal-simulation-study" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Next, we’ll return to the biology and approximate sampling scheme for bearded seals (presented as slides
in earlier in this workshop). Although bearded seal samples have already been gathered, we could look
at a number of different features of data collection that could be relevant for future monitoring.<br />
Some ideas include:</p>
<ul>
<li><p>What type of precision can we expect on adult abundance?</p></li>
<li><p>How does our current approach of treating age as known tend to affect estimates? Are we likely to
be over- or under-estimating abundance or survival with this strategy? Overstating precision? If this is
a large issue, we might want to institute procedures for better quantifying aging error (such as collecting two
teeth, having them both read, and fitting aging error models to the data)</p></li>
<li><p>What is the effect of employing fecundity-at-age schedules that overrepresent young animals? For instance,
even though age 6 male bearded seals are sexually mature, what if they are not as reproductively successful as older seals?</p></li>
<li><p>What seal covariates (e.g., age, sex) should be prioritized for genotyping if we’re to maximize precision in abundance estimates going forward?</p></li>
</ul>
<p>Our time in this workshop is limited, however, so let’s just address the first of these for this lab (what kind of standard error can we expect?).</p>
<div id="setting-up-simulations-population-dynamics" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.2.1</span> Setting up simulations: Population dynamics<a href="design-of-ckmr-experiments.html#setting-up-simulations-population-dynamics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’re going to use the R package CKMRpop to simulate some virtual bearded seal data, and fit an age structured CKMR model to these data. Given that it’s an age structured model, we’ll need to be careful that the simulation and estimation models are set up similarly - in particular we’ll want to make sure we get pre- and post-breeding census details correct. In fact, many published studies in the ecological literature have erred at this stage! (<span class="citation">Kendall <em>et al.</em> (<a href="#ref-KendallEtAl2019" role="doc-biblioref">2019</a>)</span>).</p>
<p>For bearded seals, pupping occurs from April-June on ice floes; harvests occur year round, but are primarily concentrated in the spring and summer. For this reason, we’ll use a “post-breeding census” where abundance is counted <em>after</em> reproduction has occurred. Pictorally, this looks like</p>
<p><img src="images/life_cycle_bearded.jpg" width="300" /></p>
<p>The part that people mess up most often is not incorporating survival into the fecundity term. We’ll
include 40 ages (0-39) in our model, as the probability of a bearded seal surviving past that point is really small
(I believe the oldest known age is in the 30s).</p>
<p>Speaking of which, we’ll need to use some values of age-specific survival (<span class="math inline">\(\phi_a\)</span>) and female fecundity-at-age (<span class="math inline">\(f_a\)</span>) to parameterize our simulation model. We’ll also need some information on male reproduction to determine who successfully mates or not. We’ll use data on male sexual maturity-at-age (call this <span class="math inline">\(m_a\)</span>). We’ve developed a bearded seal survival schedule based on hierarchical meta-analysis of phocid natural mortality (<span class="citation">Trukhanova <em>et al.</em> (<a href="#ref-TrukhanovaEtAl2018" role="doc-biblioref">2018</a>)</span>), and <span class="math inline">\(f_a\)</span> and <span class="math inline">\(m_a\)</span> schedules based on examination of gonadal inspections of harvested seals conducted by ADF&amp;G and reported in Russian literature. Here are some plots of these values.</p>
<p><img src="images/bearded_life_history.jpg" width="300" /></p>
<p>Let’s use these survival and fecundity values to parameterize a Leslie matrix model.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="design-of-ckmr-experiments.html#cb70-1"></a>  Maturity =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;./csv/Maturity.csv&quot;</span>)</span>
<span id="cb70-2"><a href="design-of-ckmr-experiments.html#cb70-2"></a>  Survival =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;./csv/Survival_ests.csv&quot;</span>)</span>
<span id="cb70-3"><a href="design-of-ckmr-experiments.html#cb70-3"></a>  Reprod =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;./csv/Reproduction_table.csv&quot;</span>)</span>
<span id="cb70-4"><a href="design-of-ckmr-experiments.html#cb70-4"></a>  </span>
<span id="cb70-5"><a href="design-of-ckmr-experiments.html#cb70-5"></a>  Male_mat &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">40</span>)</span>
<span id="cb70-6"><a href="design-of-ckmr-experiments.html#cb70-6"></a>  Fem_fec &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="fl">0.938</span>,<span class="dv">40</span>)</span>
<span id="cb70-7"><a href="design-of-ckmr-experiments.html#cb70-7"></a>  Male_mat[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]=<span class="kw">c</span>(<span class="dv">0</span>,Maturity<span class="op">$</span>Bearded.male)</span>
<span id="cb70-8"><a href="design-of-ckmr-experiments.html#cb70-8"></a>  Fem_fec[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]=<span class="kw">c</span>(<span class="dv">0</span>,Reprod<span class="op">$</span>bearded)</span>
<span id="cb70-9"><a href="design-of-ckmr-experiments.html#cb70-9"></a>  </span>
<span id="cb70-10"><a href="design-of-ckmr-experiments.html#cb70-10"></a>  A =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dv">40</span>,<span class="dv">40</span>)  </span>
<span id="cb70-11"><a href="design-of-ckmr-experiments.html#cb70-11"></a>  <span class="cf">for</span>(iage <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">39</span>){</span>
<span id="cb70-12"><a href="design-of-ckmr-experiments.html#cb70-12"></a>    A[iage<span class="op">+</span><span class="dv">1</span>,iage]=Survival[iage,<span class="st">&quot;bearded&quot;</span>]  <span class="co">#assume post-breeding census</span></span>
<span id="cb70-13"><a href="design-of-ckmr-experiments.html#cb70-13"></a>  }</span>
<span id="cb70-14"><a href="design-of-ckmr-experiments.html#cb70-14"></a></span>
<span id="cb70-15"><a href="design-of-ckmr-experiments.html#cb70-15"></a>  <span class="co">#reproduction; nb: adults have to survive to next spring to reproduce</span></span>
<span id="cb70-16"><a href="design-of-ckmr-experiments.html#cb70-16"></a>  <span class="co"># nb: Leslie matrices are &quot;female only&quot; and assume a 50/50 sex ratio at birth</span></span>
<span id="cb70-17"><a href="design-of-ckmr-experiments.html#cb70-17"></a>  A[<span class="dv">1</span>,]=<span class="fl">0.5</span><span class="op">*</span>Fem_fec<span class="op">*</span>Survival<span class="op">$</span>bearded  </span></code></pre></div>
<p>There’s a bit of a hiccup, however, since the population growth rate implied by
this matrix (as determined by the dominant eigenvalue) is .
Given that we’re going to need to perform simulation over 100 years (usually we have
to go back two generations to get kinship relationships right), this would have the effect
of inducing a 5400+0i percent increase in abundance over the
simulation period!! This is clearly not desirable. It’s also an indication that there is
probably something a bit off with our Leslie matrix, but it’s not clear where the bias might be.
It could have to do with reproductively mature females not always producing a pup every year (<span class="math inline">\(f_a\)</span> biased
high), or with survival being overestimated. For the purposes of this simulation, though,
we’ll lower survival by multiplying by a fixed constant until <span class="math inline">\(\lambda \approx 1.0\)</span>. Let’s
write a quick function to figure out what this constant should be.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="design-of-ckmr-experiments.html#cb71-1"></a>leslie_obj &lt;-<span class="st"> </span><span class="cf">function</span>(const,Survival,Fem_fec){</span>
<span id="cb71-2"><a href="design-of-ckmr-experiments.html#cb71-2"></a>  A =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dv">40</span>,<span class="dv">40</span>)  </span>
<span id="cb71-3"><a href="design-of-ckmr-experiments.html#cb71-3"></a>  <span class="cf">for</span>(iage <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">39</span>){</span>
<span id="cb71-4"><a href="design-of-ckmr-experiments.html#cb71-4"></a>    A[iage<span class="op">+</span><span class="dv">1</span>,iage]=const<span class="op">*</span>Survival[iage,<span class="st">&quot;bearded&quot;</span>]  <span class="co">#assume post-breeding census</span></span>
<span id="cb71-5"><a href="design-of-ckmr-experiments.html#cb71-5"></a>  }</span>
<span id="cb71-6"><a href="design-of-ckmr-experiments.html#cb71-6"></a>  A[<span class="dv">1</span>,]=<span class="fl">0.5</span><span class="op">*</span>Fem_fec<span class="op">*</span>Survival<span class="op">$</span>bearded<span class="op">*</span>const</span>
<span id="cb71-7"><a href="design-of-ckmr-experiments.html#cb71-7"></a>  </span>
<span id="cb71-8"><a href="design-of-ckmr-experiments.html#cb71-8"></a>  lambda =<span class="st"> </span><span class="kw">eigen</span>(A)<span class="op">$</span>values[<span class="dv">1</span>]</span>
<span id="cb71-9"><a href="design-of-ckmr-experiments.html#cb71-9"></a>  obj=(lambda<span class="fl">-1.0</span>)<span class="op">^</span><span class="dv">2</span></span>
<span id="cb71-10"><a href="design-of-ckmr-experiments.html#cb71-10"></a>  obj</span>
<span id="cb71-11"><a href="design-of-ckmr-experiments.html#cb71-11"></a>}</span>
<span id="cb71-12"><a href="design-of-ckmr-experiments.html#cb71-12"></a></span>
<span id="cb71-13"><a href="design-of-ckmr-experiments.html#cb71-13"></a>opt =<span class="st"> </span><span class="kw">nlminb</span>(<span class="fl">0.9</span>,leslie_obj,<span class="dt">Survival=</span>Survival,<span class="dt">Fem_fec=</span>Fem_fec)</span>
<span id="cb71-14"><a href="design-of-ckmr-experiments.html#cb71-14"></a><span class="kw">print</span>(opt<span class="op">$</span>par,<span class="dt">digits=</span><span class="dv">4</span>)</span></code></pre></div>
<pre><code>## [1] 0.9607</code></pre>
<p>We’ve got it! Okay, we’ll multiply our current survival schedule by
when we conduct our simulations - there will be some demographic stochasticity in any individual-based simulation, but given the large population size abundance should stay pretty much constant.</p>
</div>
<div id="setting-up-simulations-ckmrpop" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.2.2</span> Setting up simulations: CKMRpop<a href="design-of-ckmr-experiments.html#setting-up-simulations-ckmrpop" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our next step will be to use the R package CKMRpop to simulate population dynamics.
If you were using the ‘CKMRpop’ package on your own, you would need to install
it first like this:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="design-of-ckmr-experiments.html#cb73-1"></a>remotes<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;eriqande/CKMRpop&quot;</span>)</span></code></pre></div>
<p>However, it has already been installed for the <code>tws-ckmr-2022</code> RStudio project by the ‘renv’ package,
so if you are working in the <code>tws-ckmr-2022</code> you do not have to do the above.</p>
<p>However, after installing it, you will have to download the compiled <code>spip</code> binary
which is the underlying simulation engine. That is done with the <code>install_spip()</code> function
from the ‘CKMRpop’ as shown below:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="design-of-ckmr-experiments.html#cb74-1"></a><span class="kw">library</span>(CKMRpop)</span>
<span id="cb74-2"><a href="design-of-ckmr-experiments.html#cb74-2"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb74-3"><a href="design-of-ckmr-experiments.html#cb74-3"></a><span class="kw">install_spip</span>(<span class="dt">Dir =</span> <span class="kw">system.file</span>(<span class="dt">package =</span> <span class="st">&quot;CKMRpop&quot;</span>))</span></code></pre></div>
<p>Now, let’s set up simulations with our bearded seal life history values. Note the quotation list structure is required by CKMRpop, and that the package is set up to work with a post-breeding census (good for us!). For definitions of the <em>pars</em> list, please use <em>spip_help()</em> or <em>spip_help_full()</em>.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="design-of-ckmr-experiments.html#cb75-1"></a>pars &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb75-2"><a href="design-of-ckmr-experiments.html#cb75-2"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">max-age</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="dv">40</span>  <span class="co">#high survival so need to run for quite a while to kill everyone off</span></span>
<span id="cb75-3"><a href="design-of-ckmr-experiments.html#cb75-3"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">fem-surv-probs</span><span class="st">`</span> &lt;-<span class="st"> </span>pars<span class="op">$</span><span class="st">`</span><span class="dt">male-surv-probs</span><span class="st">`</span> &lt;-<span class="st"> </span>Survival<span class="op">$</span>bearded<span class="op">*</span>opt<span class="op">$</span>par</span>
<span id="cb75-4"><a href="design-of-ckmr-experiments.html#cb75-4"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">fem-prob-repro</span><span class="st">`</span> &lt;-<span class="st"> </span>Fem_fec <span class="co">#probability of reproduction *</span></span>
<span id="cb75-5"><a href="design-of-ckmr-experiments.html#cb75-5"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">repro-inhib</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="dv">0</span>  <span class="co">#this would allow us to specify e.g. that females couldn&#39;t have pups 2 years in a row (we don&#39;t have that issue!)</span></span>
<span id="cb75-6"><a href="design-of-ckmr-experiments.html#cb75-6"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">male-prob-repro</span><span class="st">`</span> &lt;-<span class="st"> </span>Male_mat</span>
<span id="cb75-7"><a href="design-of-ckmr-experiments.html#cb75-7"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">fem-asrf</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">40</span>)  <span class="co">#if they reproduce, they will have at most 1 offspring</span></span>
<span id="cb75-8"><a href="design-of-ckmr-experiments.html#cb75-8"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">male-asrp</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">40</span>)  <span class="co">#each reproductively mature male has same expected repro output</span></span>
<span id="cb75-9"><a href="design-of-ckmr-experiments.html#cb75-9"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">offsp-dsn</span><span class="st">`</span> &lt;-<span class="st"> &quot;binary&quot;</span>  <span class="co">#override default neg. binomial dist. for litter size</span></span>
<span id="cb75-10"><a href="design-of-ckmr-experiments.html#cb75-10"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">sex-ratio</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="fl">0.5</span></span></code></pre></div>
<p>Now we’ll set up some initial conditions and specify the length of the simulations. We’ll base the age structure of founders on stable age proportions computed using Leslie matrices, as calculated via the <em>leslie_from_spip</em> functionality in <strong>CKMRpop</strong>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="design-of-ckmr-experiments.html#cb76-1"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">number-of-years</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="dv">120</span>  </span>
<span id="cb76-2"><a href="design-of-ckmr-experiments.html#cb76-2"></a><span class="co"># we need to specify initial cohort size instead of pop size; let&#39;s set it by assuming</span></span>
<span id="cb76-3"><a href="design-of-ckmr-experiments.html#cb76-3"></a><span class="co"># a population size to be 400,000 and by using stable age proportions to figure out what</span></span>
<span id="cb76-4"><a href="design-of-ckmr-experiments.html#cb76-4"></a><span class="co"># percentage will be pups</span></span>
<span id="cb76-5"><a href="design-of-ckmr-experiments.html#cb76-5"></a>N_init =<span class="st"> </span><span class="dv">400000</span></span>
<span id="cb76-6"><a href="design-of-ckmr-experiments.html#cb76-6"></a>Age_props =<span class="st"> </span><span class="kw">eigen</span>(A)<span class="op">$</span>vectors[,<span class="dv">1</span>]<span class="op">/</span><span class="kw">sum</span>(<span class="kw">eigen</span>(A)<span class="op">$</span>vectors[,<span class="dv">1</span>])</span>
<span id="cb76-7"><a href="design-of-ckmr-experiments.html#cb76-7"></a>cohort_size &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">round</span>(N_init<span class="op">*</span>Age_props[<span class="dv">1</span>]))</span>
<span id="cb76-8"><a href="design-of-ckmr-experiments.html#cb76-8"></a><span class="co"># There&#39;s also some Leslie matrix functionality in spip we could use to set initial age strcutrue</span></span>
<span id="cb76-9"><a href="design-of-ckmr-experiments.html#cb76-9"></a>L &lt;-<span class="st"> </span><span class="kw">leslie_from_spip</span>(pars, cohort_size)</span>
<span id="cb76-10"><a href="design-of-ckmr-experiments.html#cb76-10"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">initial-males</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="kw">floor</span>(L<span class="op">$</span>stable_age_distro_fem)</span>
<span id="cb76-11"><a href="design-of-ckmr-experiments.html#cb76-11"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">initial-females</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="kw">floor</span>(L<span class="op">$</span>stable_age_distro_male)</span>
<span id="cb76-12"><a href="design-of-ckmr-experiments.html#cb76-12"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">cohort-size</span><span class="st">`</span> &lt;-<span class="st"> &quot;const 68737&quot;</span></span></code></pre></div>
<p>Note that when the <em>cohort size</em> argument is set to a constant, that the implied fecundity values in the Leslie matrix are rescaled so that the finite population growth rate, <span class="math inline">\(\lambda\)</span>, is 1.0. This can be useful for simulation, but may make comparing fecundity values estimated by a CKMR model to those used to simulate the data difficult (although fecundity-at-age curves should be proportional). If this feature isn’t desired, <strong>CKMRpop</strong> can also be run with time-specific cohort sizes, or <strong>fishsim</strong> can be used for simulation.</p>
<p>Next, we need to specify how the population is sampled. We’ll assume 20 years of sampling, which are preceded by 100 years of simulations time. This way we will likely capture the oldest possible grandparent-grandchild relationships (e.g., an individual who is age 35 at year 101 having a parent born in year 35 and a grandparent born in year 1). To be really careful we might have three generations time prior to sampling, but given that parents can’t reproduce until age 4 or 5, and that the chances of surviving to old age are very low, we should be fine.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="design-of-ckmr-experiments.html#cb77-1"></a>samp_start_year &lt;-<span class="st"> </span><span class="dv">101</span></span>
<span id="cb77-2"><a href="design-of-ckmr-experiments.html#cb77-2"></a>samp_stop_year &lt;-<span class="st"> </span><span class="dv">120</span></span>
<span id="cb77-3"><a href="design-of-ckmr-experiments.html#cb77-3"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">discard-all</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb77-4"><a href="design-of-ckmr-experiments.html#cb77-4"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">gtyp-ppn-fem-post</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="kw">paste</span>(</span>
<span id="cb77-5"><a href="design-of-ckmr-experiments.html#cb77-5"></a>  samp_start_year, <span class="st">&quot;-&quot;</span>, samp_stop_year, <span class="st">&quot; &quot;</span>, </span>
<span id="cb77-6"><a href="design-of-ckmr-experiments.html#cb77-6"></a>  <span class="kw">paste</span>(<span class="kw">rep</span>(<span class="fl">0.00025</span>, pars<span class="op">$</span><span class="st">`</span><span class="dt">max-age</span><span class="st">`</span>), <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</span>
<span id="cb77-7"><a href="design-of-ckmr-experiments.html#cb77-7"></a>  <span class="dt">sep =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb77-8"><a href="design-of-ckmr-experiments.html#cb77-8"></a>)  <span class="co">#basically we&#39;re saying that hunters aren&#39;t biased towards a particular age class, and that we&#39;re sampling 0.025% of the pop per year - about 100/year</span></span>
<span id="cb77-9"><a href="design-of-ckmr-experiments.html#cb77-9"></a>pars<span class="op">$</span><span class="st">`</span><span class="dt">gtyp-ppn-male-post</span><span class="st">`</span> &lt;-<span class="st"> </span>pars<span class="op">$</span><span class="st">`</span><span class="dt">gtyp-ppn-fem-post</span><span class="st">`</span></span></code></pre></div>
<p>Okay, now that things are set up, we can run a CKMRpop simulation! This is super easy, although
it takes a few minutes since we’re talking about simulating a populations size of 400,000 of 120 years and recording the geneaology along the way. I’m actually super impressed that this is so fast! I’ve put in an option for Rmarkdown to “cache” the results of this operation so that it doesn’t have to do it when this is compiled. So, just beware if you’re trying to run it on your own computer!!</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="design-of-ckmr-experiments.html#cb78-1"></a><span class="kw">set.seed</span>(<span class="dv">2020</span>)  <span class="co"># inauspicious year as a seed for reproducibility of results</span></span>
<span id="cb78-2"><a href="design-of-ckmr-experiments.html#cb78-2"></a>spip_dir &lt;-<span class="st"> </span><span class="kw">run_spip</span>(<span class="dt">pars =</span> pars)  <span class="co"># run spip</span></span></code></pre></div>
<pre><code>## Running spip in directory /var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T//RtmpgOCSlV/file2c332338df03</code></pre>
<pre><code>## Done running spip. Output file size is 1130.219259 Mb</code></pre>
<pre><code>## Processing output file with awk</code></pre>
<pre><code>## Done processing output into spip_pedigree.tsv, spip_prekill_census.tsv, and spip_samples.tsv</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="design-of-ckmr-experiments.html#cb83-1"></a>slurped &lt;-<span class="st"> </span><span class="kw">slurp_spip</span>(spip_dir, <span class="dv">2</span>) <span class="co"># read the spip output into R</span></span></code></pre></div>
<pre><code>## Rows: 1627 Columns: 3</code></pre>
<pre><code>## ── Column specification ───────────────────────────────
## Delimiter: &quot;\t&quot;
## chr (2): X1, X2
## lgl (1): X3
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="design-of-ckmr-experiments.html#cb86-1"></a><span class="kw">ggplot_census_by_year_age_sex</span>(slurped<span class="op">$</span>census_postkill)</span></code></pre></div>
<p><img src="tws-ckmr-2022_files/figure-html/sim1-1.png" width="672" /></p>
<p>The above plot shows the age and sex composition, as well as the total size of the population over time. For a design study the next thing we want to do is to start looking at sampled animals and number of kin pairs to make sure they line up with what we were hoping.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="design-of-ckmr-experiments.html#cb87-1"></a>  <span class="kw">nrow</span>(slurped<span class="op">$</span>samples)</span></code></pre></div>
<pre><code>## [1] 1627</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="design-of-ckmr-experiments.html#cb89-1"></a>  crel &lt;-<span class="st"> </span><span class="kw">compile_related_pairs</span>(slurped<span class="op">$</span>samples)</span></code></pre></div>
<p>So, after 20 years of sampling (at an average of 81.35 samples per year), we end up with 1627 tissue samples. Assuming none are corrupted (a dubious assumption), they can be genetically analyzed and kin relationships can be determined. <strong>CKMRpop</strong> actually keeps track of <em>a lot</em> of relationships - more than are needed for CKMR analysis (at least in CKMR’s current state). Nevertheless, they can be useful because they can allow us to examine the performance of CKMR estimators when there are errors in kin determination (e.g., grandparent-grandchild or aunt-niece being mistaken for half-sibs). Here is a summary of true kin-pairs in our sample:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="design-of-ckmr-experiments.html#cb90-1"></a>relat_counts &lt;-<span class="st"> </span><span class="kw">count_and_plot_ancestry_matrices</span>(crel)</span>
<span id="cb90-2"><a href="design-of-ckmr-experiments.html#cb90-2"></a>relat_counts<span class="op">$</span>highly_summarised</span></code></pre></div>
<pre><code>## # A tibble: 5 × 3
##   dom_relat max_hit     n
##   &lt;chr&gt;       &lt;int&gt; &lt;int&gt;
## 1 FC              1    54
## 2 A               1    30
## 3 Si              1    12
## 4 GP              1     4
## 5 PO              1     4</code></pre>
<p>Note that there are 54 half-cousins (FC), 30 half-niblings (aunt-niece, uncle-niece, etc.), 12 half-siblings, 4 grandparent-grandchild, and 4 parent-offspring pairs. Note that the “max_hit” column
indicates that number of shared ancestors at the level of the dominant relationship; so a “2” in this column would indicate a full sibling, full aunt-niece, etc. Since the maximum value if 1 here, this indicates they are all half-sibling, half-aunt-niece, etc. Which is good, since presence of full niblings/thiatics would confound HSP inference. There are some additional graphical tools in <strong>CKMRpop</strong> to examine pairwise relationships (see the plot_conn_comps() function, or investigate the “plots” objects in the relat_counts object), but we won’t do that in this manual (free feel to do so yourself though!).</p>
<p>What else may we deduce at this point? First, with only 4 POPs and 12 HSPs, we’re considerably below the “rule of thumb” of 50 kin pairs for reliable CKMR inference. These numbers may change slightly if we were to repeat the simulation, but the total number will be in the same ballpark. Second, we do get a substantial amount of GGPs, so we’ll need to accommodate these somehow, either by modeling or by restricting the time-of-death and age-ranges of HSP comparisons to make sure that GGPs are not included in HSP comparisons.</p>
<p>We’re in the unique position of actually having conducted kin finding on <span class="math inline">\(\approx 1500\)</span> real bearded seal samples, so it is instructive to compare results of simulations to real data. When we analyzed real bearded seal data, we found 2 POPs, and depending on where we put the PLOD threshold, we arrived at 17-25 HSPs + GGPs. However, this number may have been inflated by a larger-than-expected number of PHSPs (arising, perhaps, from heterogeneity in male reproductive success). So simulations largely gave numbers very similar when we went and applied CKMR in practice, which is encouraging!</p>
</div>
<div id="formatting-data-for-estimation" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.2.3</span> Formatting data for estimation<a href="design-of-ckmr-experiments.html#formatting-data-for-estimation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that we’ve simulated some data, we need to put them into a form that we can analyze. For our
bearded seal paper, I programmed a log pseudo-likelihood in TMB (see bearded_nll.cpp in the TMB directory of this project), and we will use that for estimation here. This version does not include the capacity for modeling GGPs, so let’s ignore that added complication for now (the final analysis does, but calculations are quite complex).</p>
<p>For both POPs and HSPs, we need to summarize sufficient statistics for the number of comparisons and number of matches. A typical way to do this is by grouping according to relevant covariates. For POPs this includes birth dates of the two animals being compared, as well as the death date of the older animal (because the older animal can’t be a parent if it dies before the younger animal is conceived (for a poential male parent) or before the younger animal is weaned (for a potential female parent). We’ll thus summarize POP comparisons and matches using three-dimensional arrays, which facilitate easy looping when calculating pseudolikelihood. We’ll also do maternal and paternal POPs separately. For HSPs, death dates are unneeded; all we need is the birth dates for prospective HSPs.</p>
<p>Looking at male and female fecundity-at-age vectors, it looks like we should probably limit comparisons to animals that are born within <span class="math inline">\(approx 6 years\)</span> of each other to preclude the possibility that an apparent HSP is actually a GGP. We’ll lose two HSPs in the process, but such is life!</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="design-of-ckmr-experiments.html#cb92-1"></a><span class="co"># here, &#39;bi&#39;, &#39;di&#39;, and &#39;bj&#39; index birth of the older animal, death of the older animal, and birth of the younger animal</span></span>
<span id="cb92-2"><a href="design-of-ckmr-experiments.html#cb92-2"></a><span class="co"># as far as dimensions, there are 20 years of data, but birth dates can be earlier (up one generation time)</span></span>
<span id="cb92-3"><a href="design-of-ckmr-experiments.html#cb92-3"></a>n_comp_PPO_bidibj=n_comp_MPO_bidibj=n_match_PPO_bidibj=n_match_MPO_bidibj=<span class="kw">array</span>(<span class="dv">0</span>,<span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">60</span>,<span class="dv">20</span>,<span class="dv">60</span>))</span>
<span id="cb92-4"><a href="design-of-ckmr-experiments.html#cb92-4"></a></span>
<span id="cb92-5"><a href="design-of-ckmr-experiments.html#cb92-5"></a><span class="co"># HSPs are indexed by bi, bj - the birth times of the older and younger animal; note that</span></span>
<span id="cb92-6"><a href="design-of-ckmr-experiments.html#cb92-6"></a><span class="co"># the number of comparisons does not depend on the sex of the unobserved parent, but matches are sex-specific</span></span>
<span id="cb92-7"><a href="design-of-ckmr-experiments.html#cb92-7"></a>n_comp_HS_bibj =<span class="st"> </span>n_match_PHS_bibj=<span class="st"> </span>n_match_MHS_bibj=<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dv">60</span>,<span class="dv">60</span>)</span>
<span id="cb92-8"><a href="design-of-ckmr-experiments.html#cb92-8"></a></span>
<span id="cb92-9"><a href="design-of-ckmr-experiments.html#cb92-9"></a><span class="co"># POP matches</span></span>
<span id="cb92-10"><a href="design-of-ckmr-experiments.html#cb92-10"></a>PO_only &lt;-<span class="st"> </span>crel <span class="op">%&gt;%</span></span>
<span id="cb92-11"><a href="design-of-ckmr-experiments.html#cb92-11"></a><span class="st">  </span><span class="kw">filter</span>(dom_relat <span class="op">==</span><span class="st"> &quot;PO&quot;</span>)</span>
<span id="cb92-12"><a href="design-of-ckmr-experiments.html#cb92-12"></a></span>
<span id="cb92-13"><a href="design-of-ckmr-experiments.html#cb92-13"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(PO_only)){</span>
<span id="cb92-14"><a href="design-of-ckmr-experiments.html#cb92-14"></a>  FIRST =<span class="st"> </span>(PO_only<span class="op">$</span>born_year_<span class="dv">1</span>[i] <span class="op">&lt;</span><span class="st"> </span>PO_only<span class="op">$</span>born_year_<span class="dv">2</span>[i])</span>
<span id="cb92-15"><a href="design-of-ckmr-experiments.html#cb92-15"></a>  <span class="co"># case 1: parent is animal 1</span></span>
<span id="cb92-16"><a href="design-of-ckmr-experiments.html#cb92-16"></a>  <span class="cf">if</span>(FIRST){</span>
<span id="cb92-17"><a href="design-of-ckmr-experiments.html#cb92-17"></a>    p_by =<span class="st"> </span>PO_only<span class="op">$</span>born_year_<span class="dv">1</span>[i]<span class="op">-</span><span class="dv">60</span></span>
<span id="cb92-18"><a href="design-of-ckmr-experiments.html#cb92-18"></a>    p_sex =<span class="st"> </span>(PO_only<span class="op">$</span>sex_<span class="dv">1</span>[i]<span class="op">==</span><span class="st">&quot;M&quot;</span>)<span class="op">+</span><span class="dv">1</span>  <span class="co">#1 for female, 2 for males</span></span>
<span id="cb92-19"><a href="design-of-ckmr-experiments.html#cb92-19"></a>    p_dy =<span class="st"> </span>PO_only<span class="op">$</span>samp_years_list_<span class="dv">1</span>[[i]]<span class="op">-</span><span class="dv">100</span></span>
<span id="cb92-20"><a href="design-of-ckmr-experiments.html#cb92-20"></a>    o_by =<span class="st"> </span>PO_only<span class="op">$</span>born_year_<span class="dv">2</span>[i] <span class="op">-</span><span class="st"> </span><span class="dv">60</span>  <span class="co">#year 81 in simulation = year 1 for CKMR inference</span></span>
<span id="cb92-21"><a href="design-of-ckmr-experiments.html#cb92-21"></a>  }</span>
<span id="cb92-22"><a href="design-of-ckmr-experiments.html#cb92-22"></a>  <span class="cf">else</span>{</span>
<span id="cb92-23"><a href="design-of-ckmr-experiments.html#cb92-23"></a>    p_by =<span class="st"> </span>PO_only<span class="op">$</span>born_year_<span class="dv">2</span>[i]<span class="op">-</span><span class="dv">60</span></span>
<span id="cb92-24"><a href="design-of-ckmr-experiments.html#cb92-24"></a>    p_sex =<span class="st"> </span>(PO_only<span class="op">$</span>sex_<span class="dv">2</span>[i]<span class="op">==</span><span class="st">&quot;M&quot;</span>)<span class="op">+</span><span class="dv">1</span>  <span class="co">#1 for female, 2 for males</span></span>
<span id="cb92-25"><a href="design-of-ckmr-experiments.html#cb92-25"></a>    p_dy =<span class="st"> </span>PO_only<span class="op">$</span>samp_years_list_<span class="dv">2</span>[[i]]<span class="op">-</span><span class="dv">100</span></span>
<span id="cb92-26"><a href="design-of-ckmr-experiments.html#cb92-26"></a>    o_by =<span class="st"> </span>PO_only<span class="op">$</span>born_year_<span class="dv">1</span>[i] <span class="op">-</span><span class="st"> </span><span class="dv">60</span>  <span class="co">#year 81 in simulation = year 1 for CKMR inference</span></span>
<span id="cb92-27"><a href="design-of-ckmr-experiments.html#cb92-27"></a>  }</span>
<span id="cb92-28"><a href="design-of-ckmr-experiments.html#cb92-28"></a>  <span class="cf">if</span>(p_sex<span class="op">==</span><span class="dv">1</span>)n_match_MPO_bidibj[p_by,p_dy,o_by]=n_match_MPO_bidibj[p_by,p_dy,o_by]<span class="op">+</span><span class="dv">1</span></span>
<span id="cb92-29"><a href="design-of-ckmr-experiments.html#cb92-29"></a>  <span class="cf">else</span> n_match_PPO_bidibj[p_by,p_dy,o_by]=n_match_PPO_bidibj[p_by,p_dy,o_by]<span class="op">+</span><span class="dv">1</span></span>
<span id="cb92-30"><a href="design-of-ckmr-experiments.html#cb92-30"></a>}</span>
<span id="cb92-31"><a href="design-of-ckmr-experiments.html#cb92-31"></a></span>
<span id="cb92-32"><a href="design-of-ckmr-experiments.html#cb92-32"></a><span class="co"># HSP matches</span></span>
<span id="cb92-33"><a href="design-of-ckmr-experiments.html#cb92-33"></a>HS_only &lt;-<span class="st"> </span>crel <span class="op">%&gt;%</span></span>
<span id="cb92-34"><a href="design-of-ckmr-experiments.html#cb92-34"></a><span class="st">  </span><span class="kw">filter</span>(dom_relat <span class="op">==</span><span class="st"> &quot;Si&quot;</span>)</span>
<span id="cb92-35"><a href="design-of-ckmr-experiments.html#cb92-35"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(HS_only)){</span>
<span id="cb92-36"><a href="design-of-ckmr-experiments.html#cb92-36"></a>  FIRST =<span class="st"> </span>(HS_only<span class="op">$</span>born_year_<span class="dv">1</span>[i] <span class="op">&lt;</span><span class="st"> </span>HS_only<span class="op">$</span>born_year_<span class="dv">2</span>[i])</span>
<span id="cb92-37"><a href="design-of-ckmr-experiments.html#cb92-37"></a>  lt7 =<span class="st"> </span>(<span class="kw">abs</span>(HS_only<span class="op">$</span>born_year_<span class="dv">1</span>[i] <span class="op">-</span><span class="st"> </span>HS_only<span class="op">$</span>born_year_<span class="dv">2</span>[i])<span class="op">&lt;</span><span class="dv">7</span>)</span>
<span id="cb92-38"><a href="design-of-ckmr-experiments.html#cb92-38"></a>  <span class="co"># case 1: parent is animal 1</span></span>
<span id="cb92-39"><a href="design-of-ckmr-experiments.html#cb92-39"></a>  <span class="cf">if</span>(lt7){</span>
<span id="cb92-40"><a href="design-of-ckmr-experiments.html#cb92-40"></a>    <span class="cf">if</span>(FIRST){</span>
<span id="cb92-41"><a href="design-of-ckmr-experiments.html#cb92-41"></a>      by1 =<span class="st"> </span>HS_only<span class="op">$</span>born_year_<span class="dv">1</span>[i] <span class="op">-</span><span class="st"> </span><span class="dv">60</span></span>
<span id="cb92-42"><a href="design-of-ckmr-experiments.html#cb92-42"></a>      by2 =<span class="st"> </span>HS_only<span class="op">$</span>born_year_<span class="dv">2</span>[i] <span class="op">-</span><span class="st"> </span><span class="dv">60</span>  <span class="co">#year 81 in simulation = year 1 for CKMR inference</span></span>
<span id="cb92-43"><a href="design-of-ckmr-experiments.html#cb92-43"></a>    }</span>
<span id="cb92-44"><a href="design-of-ckmr-experiments.html#cb92-44"></a>    <span class="cf">else</span>{</span>
<span id="cb92-45"><a href="design-of-ckmr-experiments.html#cb92-45"></a>      by1 =<span class="st"> </span>HS_only<span class="op">$</span>born_year_<span class="dv">2</span>[i] <span class="op">-</span><span class="st"> </span><span class="dv">60</span></span>
<span id="cb92-46"><a href="design-of-ckmr-experiments.html#cb92-46"></a>      by2 =<span class="st"> </span>HS_only<span class="op">$</span>born_year_<span class="dv">1</span>[i] <span class="op">-</span><span class="st"> </span><span class="dv">60</span>  <span class="co">#year 81 in simulation = year 1 for CKMR inference</span></span>
<span id="cb92-47"><a href="design-of-ckmr-experiments.html#cb92-47"></a>    }</span>
<span id="cb92-48"><a href="design-of-ckmr-experiments.html#cb92-48"></a>    </span>
<span id="cb92-49"><a href="design-of-ckmr-experiments.html#cb92-49"></a>    <span class="co">#to determine sex of parent, we need to access ancestry vectors and pull off an &quot;M&quot; for male or &quot;F&quot; for female</span></span>
<span id="cb92-50"><a href="design-of-ckmr-experiments.html#cb92-50"></a>    parent_ID =<span class="st"> </span>HS_only<span class="op">$</span>ancestors_<span class="dv">1</span>[i][[<span class="dv">1</span>]][<span class="kw">unlist</span>(HS_only<span class="op">$</span>primary_shared_ancestors[i])[<span class="dv">1</span>]]</span>
<span id="cb92-51"><a href="design-of-ckmr-experiments.html#cb92-51"></a>    sex =<span class="st"> </span><span class="kw">substr</span>(parent_ID,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb92-52"><a href="design-of-ckmr-experiments.html#cb92-52"></a>    <span class="cf">if</span>(sex<span class="op">==</span><span class="st">&quot;F&quot;</span>)n_match_MHS_bibj[by1,by2]=n_match_MHS_bibj[by1,by2]<span class="op">+</span><span class="dv">1</span></span>
<span id="cb92-53"><a href="design-of-ckmr-experiments.html#cb92-53"></a>    <span class="cf">else</span> n_match_PHS_bibj[by1,by2]=n_match_PHS_bibj[by1,by2]<span class="op">+</span><span class="dv">1</span></span>
<span id="cb92-54"><a href="design-of-ckmr-experiments.html#cb92-54"></a>  }</span>
<span id="cb92-55"><a href="design-of-ckmr-experiments.html#cb92-55"></a>}</span>
<span id="cb92-56"><a href="design-of-ckmr-experiments.html#cb92-56"></a></span>
<span id="cb92-57"><a href="design-of-ckmr-experiments.html#cb92-57"></a></span>
<span id="cb92-58"><a href="design-of-ckmr-experiments.html#cb92-58"></a><span class="co">#Comparisons</span></span>
<span id="cb92-59"><a href="design-of-ckmr-experiments.html#cb92-59"></a>n_indiv =<span class="st"> </span><span class="kw">nrow</span>(slurped<span class="op">$</span>samples)</span>
<span id="cb92-60"><a href="design-of-ckmr-experiments.html#cb92-60"></a><span class="cf">for</span>(i1 <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n_indiv<span class="dv">-1</span>)){</span>
<span id="cb92-61"><a href="design-of-ckmr-experiments.html#cb92-61"></a>  <span class="cf">for</span>(i2 <span class="cf">in</span> (i1<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>n_indiv){</span>
<span id="cb92-62"><a href="design-of-ckmr-experiments.html#cb92-62"></a>    born_diff =<span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>born_year[i1] <span class="op">-</span><span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>born_year[i2]</span>
<span id="cb92-63"><a href="design-of-ckmr-experiments.html#cb92-63"></a>    <span class="cf">if</span>(<span class="kw">abs</span>(born_diff)<span class="op">&lt;</span><span class="dv">7</span>){ </span>
<span id="cb92-64"><a href="design-of-ckmr-experiments.html#cb92-64"></a>      <span class="cf">if</span>(born_diff<span class="op">&lt;</span><span class="dv">0</span>){ <span class="co">#first animal is older</span></span>
<span id="cb92-65"><a href="design-of-ckmr-experiments.html#cb92-65"></a>        p_by =<span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>born_year[i1]<span class="op">-</span><span class="dv">60</span></span>
<span id="cb92-66"><a href="design-of-ckmr-experiments.html#cb92-66"></a>        p_dy =<span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>samp_years_list[i1][[<span class="dv">1</span>]]<span class="op">-</span><span class="dv">100</span></span>
<span id="cb92-67"><a href="design-of-ckmr-experiments.html#cb92-67"></a>        p_sex =<span class="st"> </span>(slurped<span class="op">$</span>samples<span class="op">$</span>sex[i1]<span class="op">==</span><span class="st">&quot;M&quot;</span>)<span class="op">+</span><span class="dv">1</span>  <span class="co">#1 for female, 2 for males</span></span>
<span id="cb92-68"><a href="design-of-ckmr-experiments.html#cb92-68"></a>        o_by =<span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>born_year[i2] <span class="op">-</span><span class="st"> </span><span class="dv">60</span>  <span class="co">#year 81 in simulation = year 1 for CKMR   </span></span>
<span id="cb92-69"><a href="design-of-ckmr-experiments.html#cb92-69"></a>      }</span>
<span id="cb92-70"><a href="design-of-ckmr-experiments.html#cb92-70"></a>      <span class="cf">else</span>{</span>
<span id="cb92-71"><a href="design-of-ckmr-experiments.html#cb92-71"></a>        <span class="cf">if</span>(born_diff<span class="op">&gt;</span><span class="dv">0</span>){ <span class="co">#note no comparisons for animals born in same year</span></span>
<span id="cb92-72"><a href="design-of-ckmr-experiments.html#cb92-72"></a>          p_by =<span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>born_year[i2]<span class="op">-</span><span class="dv">60</span></span>
<span id="cb92-73"><a href="design-of-ckmr-experiments.html#cb92-73"></a>          p_dy =<span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>samp_years_list[i2][[<span class="dv">1</span>]]<span class="op">-</span><span class="dv">100</span></span>
<span id="cb92-74"><a href="design-of-ckmr-experiments.html#cb92-74"></a>          p_sex =<span class="st"> </span>(slurped<span class="op">$</span>samples<span class="op">$</span>sex[i2]<span class="op">==</span><span class="st">&quot;M&quot;</span>)<span class="op">+</span><span class="dv">1</span>  <span class="co">#1 for female, 2 for males</span></span>
<span id="cb92-75"><a href="design-of-ckmr-experiments.html#cb92-75"></a>          o_by =<span class="st"> </span>slurped<span class="op">$</span>samples<span class="op">$</span>born_year[i1] <span class="op">-</span><span class="st"> </span><span class="dv">60</span>  <span class="co">#year 81 in simulation = year 1 for CKMR   </span></span>
<span id="cb92-76"><a href="design-of-ckmr-experiments.html#cb92-76"></a>        }</span>
<span id="cb92-77"><a href="design-of-ckmr-experiments.html#cb92-77"></a>      }</span>
<span id="cb92-78"><a href="design-of-ckmr-experiments.html#cb92-78"></a>      <span class="cf">if</span>(p_sex<span class="op">==</span><span class="dv">1</span>)n_comp_MPO_bidibj[p_by,p_dy,o_by] =<span class="st"> </span>n_comp_MPO_bidibj[p_by,p_dy,o_by] <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb92-79"><a href="design-of-ckmr-experiments.html#cb92-79"></a>      <span class="cf">else</span> n_comp_PPO_bidibj[p_by,p_dy,o_by] =<span class="st"> </span>n_comp_PPO_bidibj[p_by,p_dy,o_by] <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb92-80"><a href="design-of-ckmr-experiments.html#cb92-80"></a>      n_comp_HS_bibj[p_by,o_by]=n_comp_HS_bibj[p_by,o_by]<span class="op">+</span><span class="dv">1</span></span>
<span id="cb92-81"><a href="design-of-ckmr-experiments.html#cb92-81"></a>    }</span>
<span id="cb92-82"><a href="design-of-ckmr-experiments.html#cb92-82"></a>  }</span>
<span id="cb92-83"><a href="design-of-ckmr-experiments.html#cb92-83"></a>}</span></code></pre></div>
</div>
<div id="fitting-the-ckmr-model" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.2.4</span> Fitting the CKMR model<a href="design-of-ckmr-experiments.html#fitting-the-ckmr-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Okay, now we have our data formatted and it’s time to load up the jnll function from TMB, and pass data and initial parameter values to it to enable parameter estimation. Note that we’re going to pass fecundity schedules as known constants, and will handle survival by passing informative prior distributions into the estimation routine (it is a 3-parameter reduced-additive-Weibull model). Owing to low sample sizes, we’re also going to enforce a constraint of a constant population size. Here is some code to setup and run the model:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="design-of-ckmr-experiments.html#cb93-1"></a> Data=<span class="kw">list</span>(<span class="st">&quot;n_yrs&quot;</span>=<span class="dv">60</span>,<span class="st">&quot;n_yrs_data&quot;</span>=<span class="dv">20</span>,<span class="st">&quot;n_seals&quot;</span>=<span class="kw">nrow</span>(slurped<span class="op">$</span>samples),<span class="st">&quot;n_ages&quot;</span>=<span class="dv">40</span>,<span class="st">&quot;Male_mat&quot;</span>=Male_mat,<span class="st">&quot;Fem_fec&quot;</span>=Fem_fec,<span class="st">&quot;A&quot;</span>=A, <span class="st">&quot;n_match_PHS_bibj&quot;</span>=n_match_PHS_bibj,<span class="st">&quot;n_match_MHS_bibj&quot;</span>=n_match_MHS_bibj,<span class="st">&quot;n_comp_HS_bibj&quot;</span>=n_comp_HS_bibj,<span class="st">&quot;n_match_MPO_bidibj&quot;</span>=n_match_MPO_bidibj,<span class="st">&quot;n_comp_MPO_bidibj&quot;</span>=n_comp_MPO_bidibj,<span class="st">&quot;n_match_PPO_bidibj&quot;</span>=n_match_PPO_bidibj,<span class="st">&quot;n_comp_PPO_bidibj&quot;</span>=n_comp_PPO_bidibj,<span class="dt">mu_log_eta1=</span><span class="kw">log</span>(<span class="fl">0.055</span>),<span class="dt">mu_log_eta2=</span><span class="kw">log</span>(<span class="fl">2.8</span>),<span class="dt">mu_log_eta3=</span><span class="kw">log</span>(<span class="fl">0.076</span>),<span class="dt">sd_log_eta1=</span><span class="fl">0.07</span><span class="op">*</span><span class="kw">abs</span>(<span class="kw">log</span>(<span class="fl">0.055</span>)),<span class="dt">sd_log_eta2=</span><span class="fl">0.2</span><span class="op">*</span><span class="kw">abs</span>(<span class="kw">log</span>(<span class="fl">2.8</span>)),<span class="dt">sd_log_eta3=</span><span class="kw">abs</span>(<span class="fl">0.08</span><span class="op">*</span><span class="kw">log</span>(<span class="fl">0.076</span>)),<span class="dt">lambda_expect=</span><span class="fl">1.0</span>)  <span class="co">#SD log multipliers set to achieve approx CV of 0.2 on real scale</span></span>
<span id="cb93-2"><a href="design-of-ckmr-experiments.html#cb93-2"></a>  </span>
<span id="cb93-3"><a href="design-of-ckmr-experiments.html#cb93-3"></a>  Params =<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;n0_log&quot;</span>=<span class="kw">log</span>(<span class="dv">20000</span>),<span class="st">&quot;log_eta1&quot;</span>=<span class="kw">log</span>(<span class="fl">0.055</span>),<span class="st">&quot;log_eta2&quot;</span>=<span class="kw">log</span>(<span class="fl">2.80</span>),<span class="st">&quot;log_eta3&quot;</span>=<span class="kw">log</span>(<span class="fl">0.076</span>)) <span class="co">#intial param values</span></span>
<span id="cb93-4"><a href="design-of-ckmr-experiments.html#cb93-4"></a>   </span>
<span id="cb93-5"><a href="design-of-ckmr-experiments.html#cb93-5"></a>  Map =<span class="st"> </span><span class="kw">list</span>()  <span class="co">#specify fixed parameter values</span></span>
<span id="cb93-6"><a href="design-of-ckmr-experiments.html#cb93-6"></a>  <span class="co">#Random= c(&quot;log_eta1&quot;,&quot;log_eta2&quot;,&quot;log_eta3&quot;)</span></span>
<span id="cb93-7"><a href="design-of-ckmr-experiments.html#cb93-7"></a>  Random=<span class="ot">NULL</span></span>
<span id="cb93-8"><a href="design-of-ckmr-experiments.html#cb93-8"></a></span>
<span id="cb93-9"><a href="design-of-ckmr-experiments.html#cb93-9"></a>  <span class="kw">library</span>(TMB)</span>
<span id="cb93-10"><a href="design-of-ckmr-experiments.html#cb93-10"></a>  <span class="kw">getwd</span>()</span></code></pre></div>
<pre><code>## [1] &quot;/Users/runner/work/tws-ckmr-2022/tws-ckmr-2022&quot;</code></pre>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="design-of-ckmr-experiments.html#cb95-1"></a>  TmbFile =<span class="st"> &quot;./TMB/bearded_nll.cpp&quot;</span></span>
<span id="cb95-2"><a href="design-of-ckmr-experiments.html#cb95-2"></a>  <span class="kw">compile</span>(TmbFile )</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="design-of-ckmr-experiments.html#cb97-1"></a>  TmbExec=<span class="st">&quot;./TMB/bearded_nll&quot;</span></span>
<span id="cb97-2"><a href="design-of-ckmr-experiments.html#cb97-2"></a>  <span class="kw">dyn.load</span>(<span class="kw">dynlib</span>(TmbExec))</span>
<span id="cb97-3"><a href="design-of-ckmr-experiments.html#cb97-3"></a></span>
<span id="cb97-4"><a href="design-of-ckmr-experiments.html#cb97-4"></a>  </span>
<span id="cb97-5"><a href="design-of-ckmr-experiments.html#cb97-5"></a>  Obj &lt;-<span class="st"> </span><span class="kw">MakeADFun</span>(<span class="dt">data=</span>Data, <span class="dt">parameters=</span>Params, <span class="dt">random=</span>Random, <span class="dt">map=</span>Map, <span class="dt">hessian=</span><span class="ot">FALSE</span>, <span class="dt">DLL=</span><span class="st">&quot;bearded_nll&quot;</span>)</span>
<span id="cb97-6"><a href="design-of-ckmr-experiments.html#cb97-6"></a>  </span>
<span id="cb97-7"><a href="design-of-ckmr-experiments.html#cb97-7"></a>  Obj<span class="op">$</span><span class="kw">fn</span>( Obj<span class="op">$</span>par )</span></code></pre></div>
<pre><code>## [1] 2176425</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="design-of-ckmr-experiments.html#cb99-1"></a>  Report =<span class="st"> </span>Obj<span class="op">$</span><span class="kw">report</span>()</span>
<span id="cb99-2"><a href="design-of-ckmr-experiments.html#cb99-2"></a></span>
<span id="cb99-3"><a href="design-of-ckmr-experiments.html#cb99-3"></a>  init_report =<span class="st"> </span>Report</span>
<span id="cb99-4"><a href="design-of-ckmr-experiments.html#cb99-4"></a>  </span>
<span id="cb99-5"><a href="design-of-ckmr-experiments.html#cb99-5"></a>  <span class="co">#Minimize negative log likelihood and time it</span></span>
<span id="cb99-6"><a href="design-of-ckmr-experiments.html#cb99-6"></a>  Start_time =<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb99-7"><a href="design-of-ckmr-experiments.html#cb99-7"></a>  Opt =<span class="st"> </span><span class="kw">nlminb</span>(<span class="dt">start=</span>Params, <span class="dt">objective=</span>Obj<span class="op">$</span>fn, <span class="dt">gradient=</span>Obj<span class="op">$</span>gr)</span></code></pre></div>
<pre><code>## outer mgc:  20936170 
## outer mgc:  8511535 
## outer mgc:  1708844 
## outer mgc:  1296351 
## outer mgc:  846387 
## outer mgc:  38796 
## outer mgc:  17648 
## outer mgc:  354.1 
## outer mgc:  2343 
## outer mgc:  180.7 
## outer mgc:  1431 
## outer mgc:  2875 
## outer mgc:  1552 
## outer mgc:  1150 
## outer mgc:  45.01 
## outer mgc:  180.9 
## outer mgc:  488.8 
## outer mgc:  123.3 
## outer mgc:  12.81 
## outer mgc:  4.869 
## outer mgc:  0.3811 
## outer mgc:  3.208 
## outer mgc:  8.661 
## outer mgc:  5.924 
## outer mgc:  45.47 
## outer mgc:  7.402 
## outer mgc:  1.951 
## outer mgc:  3.413 
## outer mgc:  3.515 
## outer mgc:  2.067 
## outer mgc:  0.2946 
## outer mgc:  0.02022</code></pre>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="design-of-ckmr-experiments.html#cb101-1"></a>  End_time =<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb101-2"><a href="design-of-ckmr-experiments.html#cb101-2"></a></span>
<span id="cb101-3"><a href="design-of-ckmr-experiments.html#cb101-3"></a>  Report=Obj<span class="op">$</span><span class="kw">report</span>()</span>
<span id="cb101-4"><a href="design-of-ckmr-experiments.html#cb101-4"></a>  SD_report=<span class="kw">sdreport</span>(Obj)</span></code></pre></div>
<pre><code>## outer mgc:  0.02022 
## outer mgc:  0.06032 
## outer mgc:  0.0199 
## outer mgc:  63308 
## outer mgc:  63004 
## outer mgc:  1107 
## outer mgc:  1110 
## outer mgc:  50079 
## outer mgc:  50038 
## outer mgc:  1406518</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="design-of-ckmr-experiments.html#cb103-1"></a>  N_est_TMB =<span class="st"> </span>SD_report<span class="op">$</span>value[<span class="kw">which</span>(<span class="kw">names</span>(SD_report<span class="op">$</span>value)<span class="op">==</span><span class="st">&quot;N&quot;</span>)]</span>
<span id="cb103-2"><a href="design-of-ckmr-experiments.html#cb103-2"></a>  </span>
<span id="cb103-3"><a href="design-of-ckmr-experiments.html#cb103-3"></a>  <span class="co">#check for convergence</span></span>
<span id="cb103-4"><a href="design-of-ckmr-experiments.html#cb103-4"></a>  Opt<span class="op">$</span>message</span></code></pre></div>
<pre><code>## [1] &quot;relative convergence (4)&quot;</code></pre>
<p>Okay, so it looks like our model converged, so it’s time to check on results. It looks like we’re estimating
abundance as 2.710410^{5} with a standard error of 7.25610^{4} - so the CV is 0.2677. That’s not bad! But, remember we’ve employed a large number of assumptions (constant abundance, etc.) to get an estimate with
such low sample sizes. Our estimate (270,000) is lower than true abundance (400,000) but if we constructed a confidence interval it would include the true value, so it’s not something to be worried about. If we wanted to quantify estimator performance in a more
rigorous way, we’d want to conduct a large number of simulations and look at things like bias, confidence interval coverage, etc.</p>
<p>How about survival? Recall that CKMR can inform estimation of <em>adult</em> survival, which is why we used a prior on the three parameter survival-at-age function. Presumably the prior specifies all the information on juvenile and subadult survival, but the HSP data provide additional information on adult survival. There’s actually another hidden piece of information, and that is the constraint that population size is constant (basically a <span class="math inline">\(\lambda=1.0\)</span> constraint). So when we compare the prior survival model to the posterior survival model we see quite a shift - but a lot of that has to do with <span class="math inline">\(\lambda=1.0\)</span>.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="design-of-ckmr-experiments.html#cb105-1"></a>  Plot_df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Type&quot;</span>=<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Prior&quot;</span>,<span class="st">&quot;CKMR&quot;</span>),<span class="dt">each=</span><span class="dv">40</span>),</span>
<span id="cb105-2"><a href="design-of-ckmr-experiments.html#cb105-2"></a>                      <span class="st">&quot;Value&quot;</span>=<span class="kw">c</span>(Survival<span class="op">$</span>bearded,Report<span class="op">$</span>S_a),</span>
<span id="cb105-3"><a href="design-of-ckmr-experiments.html#cb105-3"></a>                      <span class="st">&quot;Age&quot;</span>=<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">39</span>),<span class="dv">2</span>))</span>
<span id="cb105-4"><a href="design-of-ckmr-experiments.html#cb105-4"></a>  <span class="kw">library</span>(ggplot2)</span>
<span id="cb105-5"><a href="design-of-ckmr-experiments.html#cb105-5"></a>  <span class="kw">ggplot</span>(Plot_df)<span class="op">+</span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Age,<span class="dt">y=</span>Value,<span class="dt">colour=</span>Type),<span class="dt">size=</span><span class="fl">1.1</span>)<span class="op">+</span><span class="kw">theme</span>(<span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">16</span>))</span></code></pre></div>
<p><img src="tws-ckmr-2022_files/figure-html/plot_S-1.png" width="672" /></p>
</div>
<div id="thought-experiment" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.2.5</span> Thought experiment<a href="design-of-ckmr-experiments.html#thought-experiment" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="alert alert-info">
<p><strong>Info!</strong> What else about the bearded seal example would make sense to examine using simulation??</p>
</div>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references">
<div id="ref-hillary2018genetic">
<p>Hillary R, Bravington M, Patterson T <em>et al.</em> (2018) Genetic relatedness reveals total population size of white sharks in eastern australia and new zealand. <em>Scientific reports</em>, <strong>8</strong>, 1–9.</p>
</div>
<div id="ref-KendallEtAl2019">
<p>Kendall BE, Fujiwara M, Diaz-Lopez J <em>et al.</em> (2019) Persistent problems in the construction of matrix population models. <em>Ecological modelling</em>, <strong>406</strong>, 33–43.</p>
</div>
<div id="ref-TrukhanovaEtAl2018">
<p>Trukhanova IS, Conn PB, Boveng PL (2018) Taxonomy-based hierarchical analysis of natural mortality: Polar and subpolar phocid seals. <em>Ecology and evolution</em>, <strong>8</strong>, 10530–10541.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/eriqande/tws-ckmr-2022/edit/master/015-design.Rmd",
"text": "Edit"
},
"history": {
"link": "https://github.com/eriqande/tws-ckmr-2022/commits/master/015-design.Rmd",
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["tws-ckmr-2022.pdf", "tws-ckmr-2022.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
