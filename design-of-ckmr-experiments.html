<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Session 3 Design of CKMR Experiments | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA</title>
  <meta name="description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Session 3 Design of CKMR Experiments | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="github-repo" content="yihui/bookdown-crc" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Session 3 Design of CKMR Experiments | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA" />
  
  <meta name="twitter:description" content="A book example for a Chapman &amp; Hall book." />
  

<meta name="author" content="Paul B. Conn and Eric C. Anderson" />


<meta name="date" content="2022-10-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block/empty-anchor.js"></script>
<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">TWS-CKMR-2022</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#workshop-schedule"><i class="fa fa-check"></i><b>0.1</b> Workshop schedule</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#resources"><i class="fa fa-check"></i><b>0.2</b> Resources</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#setting-computer"><i class="fa fa-check"></i><b>0.3</b> Setting up your computer</a><ul>
<li class="chapter" data-level="0.3.1" data-path="index.html"><a href="index.html#step-2.-install-a-number-of-r-packages-that-are-relatively-easy-to-install"><i class="fa fa-check"></i><b>0.3.1</b> Step 2. Install a number of R packages that are relatively easy to install</a></li>
<li class="chapter" data-level="0.3.2" data-path="index.html"><a href="index.html#step-3.-make-sure-you-have-git-and-an-account-on-github"><i class="fa fa-check"></i><b>0.3.2</b> Step 3. Make sure you have git and an account on GitHub</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html"><i class="fa fa-check"></i><b>1</b> CKMR thought experiments and labs</a><ul>
<li class="chapter" data-level="1.1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#afternoon-schedule"><i class="fa fa-check"></i><b>1.1</b> Afternoon schedule</a></li>
<li class="chapter" data-level="1.2" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#thought-experiments"><i class="fa fa-check"></i><b>1.2</b> Thought experiments</a><ul>
<li class="chapter" data-level="1.2.1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#thought-experiment-1"><i class="fa fa-check"></i><b>1.2.1</b> Thought experiment 1</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><i class="fa fa-check"></i><b>2</b> Simulation and Inference Play with Hillary et al.’s White Shark CKMR example</a><ul>
<li class="chapter" data-level="2.1" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#simulating-from-their-inferential-model"><i class="fa fa-check"></i><b>2.1</b> Simulating from their inferential model</a></li>
<li class="chapter" data-level="2.2" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#an-r-function-to-compute-the-negative-log-likelihood"><i class="fa fa-check"></i><b>2.2</b> An R function to compute the negative log-likelihood</a></li>
<li class="chapter" data-level="2.3" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#evaluate-the-likelihood-with-tmb"><i class="fa fa-check"></i><b>2.3</b> Evaluate the likelihood with TMB</a></li>
<li class="chapter" data-level="2.4" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#visualize-those-log-likelihood-values"><i class="fa fa-check"></i><b>2.4</b> Visualize those log likelihood values</a></li>
<li class="chapter" data-level="2.5" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#omg-lets-investigate-the-tmbstan-package"><i class="fa fa-check"></i><b>2.5</b> OMG! Let’s investigate the tmbstan package!</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html"><i class="fa fa-check"></i><b>3</b> Design of CKMR Experiments</a><ul>
<li class="chapter" data-level="3.1" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#white-shark-design-example"><i class="fa fa-check"></i><b>3.1</b> White shark design example</a></li>
<li class="chapter" data-level="3.2" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#fisher-information-ideas"><i class="fa fa-check"></i><b>3.2</b> Fisher information ideas</a></li>
<li class="chapter" data-level="3.3" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#calculating-expected-data-under-different-design-scenarios"><i class="fa fa-check"></i><b>3.3</b> Calculating expected data under different design scenarios</a></li>
<li class="chapter" data-level="3.4" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#calculating-expected-variance-under-different-design-scenarios"><i class="fa fa-check"></i><b>3.4</b> Calculating expected variance under different design scenarios</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Close-kin mark-recapture: theory and practice — Spokane, Washington, USA</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="design-of-ckmr-experiments" class="section level1 hasAnchor">
<h1><span class="header-section-number">Session 3</span> Design of CKMR Experiments<a href="design-of-ckmr-experiments.html#design-of-ckmr-experiments" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this lab, we’ll look at various tools to help design CKMR experiments. We’re relatively liberal with what we call a “design” tool. It could be optimizing
sample allocation to achieve maximum precision for a given parameter (e.g., which sexes and ages to target), or it could simply be examining the effect of different
types of assumption violations on estimator performance. After all, if a particular type of model is likely to lead to highly biased parameter estimates, it is probably best to adapt model structure, or to leave out certain types of kin comparisons
that are likely to violate assumptions.</p>
<p>We’ll consider two specific examples: (1) optimizing sample allocation in <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> white shark example, and (2) conducting individual-based
simulation to investigate impacts of assumption violations in CKMR models for “weirded seals”. As a reminder, weirded seals are our pet name for bearded seals in and around Alaska, but with some of the data changed to protect their integrity
prior to the bearded seal study actually being published.</p>
<div id="white-shark-design-example" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.1</span> White shark design example<a href="design-of-ckmr-experiments.html#white-shark-design-example" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In a previous lab, we looked at <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> model using cross-cohort comparisons of half siblings caught as juveniles. We might look at a few things with this example, such as how we would partition samples across years and ages if we had the ability to do so. Presumably, the optimal allocation would depend on the parameter
we were interested in (e.g., population growth (<span class="math inline">\(\lambda\)</span>), adult survival (<span class="math inline">\(S\)</span>) or
terminal year abundance (call this <span class="math inline">\(N_T\)</span>). Both <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(S\)</span> are parameters of the CKMR model, but <span class="math inline">\(N_T\)</span> is a derived parameter (that is, a <em>function</em> of parameters) and can be computed as</p>
<p><span class="math display">\[\begin{equation*}
  N_T = N_0 * \exp(\lambda  T) 
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(T\)</span> is the number of years in the study.</p>
</div>
<div id="fisher-information-ideas" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.2</span> Fisher information ideas<a href="design-of-ckmr-experiments.html#fisher-information-ideas" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll be using Fisher information ideas to compare anticipated precision
associated with various white shark sampling designs. As articulated in the
slides on design for this workshop, this involves a number of steps:</p>
<ol style="list-style-type: decimal">
<li><p>Allocate potential sample sizes to particular years, ages, sexes, etc. (basically the different covariates one is modeling). These can be expectations (fractions)!</p></li>
<li><p>Compute sufficient statistics (expected # of comparisons and number of matches for each covariate combination)</p></li>
<li><p>Treating these as data, calculate second derivatives of the negative log-pseudo-likelihood at the true parameter values</p></li>
<li><p>Calculate the expected variance-covariance matrix of parameters in the usual way (inverse of the numeric Fisher information matrix)</p></li>
<li><p>Calculate expected variance of any functions of parameters using the delta method</p></li>
<li><p>Compare precision (e.g. CV) associated with different designs!!</p></li>
</ol>
<p>Fortunately, we already have the infrastructure set up to help us the negative log-pseudo-likelihood (both in R and TMB). We <em>could</em> use numerical second derivatives (e.g., using the <span class="math inline">\(numDeriv\)</span> package in R) and
not even have to deal with minimizing the NLPL, but Template Model Builder is well set up to produce numerical variance-covariance matrices (including functions of parameters), so why don’t we just follow the path of least resistance and fit our model using TMB. We’ll still need
to formulate some alternative designs and what the expected data would look like under each.</p>
</div>
<div id="calculating-expected-data-under-different-design-scenarios" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.3</span> Calculating expected data under different design scenarios<a href="design-of-ckmr-experiments.html#calculating-expected-data-under-different-design-scenarios" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s set up “true” population dynamics to consist of a stable population with 1000 adults
which we assume to be constant over a 20 year period. We’ll set the assume a constant adult survival probability of 0.94, and that sampling occurs over the last 10 years of the time interval. We’ll assume that sampling targets juveniles (ages 3-8) only, so the most we’ll have to go back in time is 8 years (which is why the model needs to go back further in time than just the years that are sampled!!).</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="design-of-ckmr-experiments.html#cb42-1"></a>Ninit =<span class="st"> </span><span class="dv">1000</span> </span>
<span id="cb42-2"><a href="design-of-ckmr-experiments.html#cb42-2"></a>lambda =<span class="st"> </span><span class="fl">0.0</span></span>
<span id="cb42-3"><a href="design-of-ckmr-experiments.html#cb42-3"></a>n_yrs =<span class="st"> </span><span class="dv">20</span></span>
<span id="cb42-4"><a href="design-of-ckmr-experiments.html#cb42-4"></a>N =<span class="st"> </span><span class="kw">matrix</span>(Ninit,<span class="dv">20</span>)</span>
<span id="cb42-5"><a href="design-of-ckmr-experiments.html#cb42-5"></a>phiA =<span class="st"> </span><span class="fl">0.94</span></span>
<span id="cb42-6"><a href="design-of-ckmr-experiments.html#cb42-6"></a>ylo=<span class="dv">11</span></span>
<span id="cb42-7"><a href="design-of-ckmr-experiments.html#cb42-7"></a>yhi=<span class="dv">20</span></span>
<span id="cb42-8"><a href="design-of-ckmr-experiments.html#cb42-8"></a>ages =<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">8</span>)  <span class="co">#only 3 - 8 yrs olds sampled</span></span>
<span id="cb42-9"><a href="design-of-ckmr-experiments.html#cb42-9"></a></span>
<span id="cb42-10"><a href="design-of-ckmr-experiments.html#cb42-10"></a><span class="co">#&#39; Function to calculate # of expected pairs given true adult abundance, adult</span></span>
<span id="cb42-11"><a href="design-of-ckmr-experiments.html#cb42-11"></a><span class="co">#&#39; survival, and # of juvenile white sharks sampled per year (males and female parents modeled together!)</span></span>
<span id="cb42-12"><a href="design-of-ckmr-experiments.html#cb42-12"></a><span class="co">#&#39; @param Npy vector of number of sharks to sample each year (num per year)</span></span>
<span id="cb42-13"><a href="design-of-ckmr-experiments.html#cb42-13"></a><span class="co">#&#39; @param ages a vector of the ages at which individuals are sampled</span></span>
<span id="cb42-14"><a href="design-of-ckmr-experiments.html#cb42-14"></a><span class="co">#&#39; @param age_wts vector of expected proportion of each age in the sample</span></span>
<span id="cb42-15"><a href="design-of-ckmr-experiments.html#cb42-15"></a><span class="co">#&#39; @param N Vector of number of adults per year</span></span>
<span id="cb42-16"><a href="design-of-ckmr-experiments.html#cb42-16"></a><span class="co">#&#39; @param phiA Adult annual survival probability</span></span>
<span id="cb42-17"><a href="design-of-ckmr-experiments.html#cb42-17"></a><span class="co">#&#39; @return This returns two upper triangular matrices `M` and `EC`, both of which have dimension </span></span>
<span id="cb42-18"><a href="design-of-ckmr-experiments.html#cb42-18"></a><span class="co">#&#39; (n_yrs x #&#39; n_yrs).  The M matrix holds the number of comparisons where the row indexes the </span></span>
<span id="cb42-19"><a href="design-of-ckmr-experiments.html#cb42-19"></a><span class="co">#&#39; birth year of the older #&#39; half-sib, and the column gives the birth year of the younger </span></span>
<span id="cb42-20"><a href="design-of-ckmr-experiments.html#cb42-20"></a><span class="co">#&#39; half sib.  The EC matrix is organized the same way, but holds the expected half-sib count </span></span>
<span id="cb42-21"><a href="design-of-ckmr-experiments.html#cb42-21"></a><span class="co">#&#39; (i.e. # of matches)</span></span>
<span id="cb42-22"><a href="design-of-ckmr-experiments.html#cb42-22"></a>expected_data &lt;-<span class="st"> </span><span class="cf">function</span>(Npy,ylo,yhi,ages,age_wts,N,phiA){</span>
<span id="cb42-23"><a href="design-of-ckmr-experiments.html#cb42-23"></a>  age_wts =<span class="st"> </span>age_wts<span class="op">/</span><span class="kw">sum</span>(age_wts)  <span class="co">#normalize if not </span></span>
<span id="cb42-24"><a href="design-of-ckmr-experiments.html#cb42-24"></a>  n_ages =<span class="st"> </span><span class="kw">max</span>(ages)<span class="op">+</span><span class="dv">1</span> <span class="co">#nb this is just age 0 to the max of sampled age</span></span>
<span id="cb42-25"><a href="design-of-ckmr-experiments.html#cb42-25"></a>  age_prob =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,n_ages)</span>
<span id="cb42-26"><a href="design-of-ckmr-experiments.html#cb42-26"></a>  age_prob[ages<span class="op">+</span><span class="dv">1</span>]=age_wts<span class="op">/</span><span class="kw">sum</span>(age_wts)</span>
<span id="cb42-27"><a href="design-of-ckmr-experiments.html#cb42-27"></a>  n_yrs =<span class="st"> </span><span class="kw">length</span>(Npy)</span>
<span id="cb42-28"><a href="design-of-ckmr-experiments.html#cb42-28"></a>  M =<span class="st"> </span>EC =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,n_yrs,n_yrs)</span>
<span id="cb42-29"><a href="design-of-ckmr-experiments.html#cb42-29"></a>  </span>
<span id="cb42-30"><a href="design-of-ckmr-experiments.html#cb42-30"></a>  <span class="co"># expected number sampled by year and age</span></span>
<span id="cb42-31"><a href="design-of-ckmr-experiments.html#cb42-31"></a>  N_samp =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,n_yrs,<span class="kw">max</span>(ages)<span class="op">+</span><span class="dv">1</span>)  <span class="co">#this holds expected number sampled by year and age (w/ age 0)</span></span>
<span id="cb42-32"><a href="design-of-ckmr-experiments.html#cb42-32"></a>  <span class="cf">for</span>(iyr <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_yrs){</span>
<span id="cb42-33"><a href="design-of-ckmr-experiments.html#cb42-33"></a>    N_samp[iyr,]=Npy[iyr]<span class="op">*</span>age_prob</span>
<span id="cb42-34"><a href="design-of-ckmr-experiments.html#cb42-34"></a>  }</span>
<span id="cb42-35"><a href="design-of-ckmr-experiments.html#cb42-35"></a>  <span class="co"># convert to number sampled by birth year</span></span>
<span id="cb42-36"><a href="design-of-ckmr-experiments.html#cb42-36"></a>  N_samp_by =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,n_yrs)</span>
<span id="cb42-37"><a href="design-of-ckmr-experiments.html#cb42-37"></a>  <span class="cf">for</span>(iyr <span class="cf">in</span> <span class="dv">11</span><span class="op">:</span>n_yrs){   <span class="co">#this would need to be changed to make general - i.e., sampling occurred &lt; year 10</span></span>
<span id="cb42-38"><a href="design-of-ckmr-experiments.html#cb42-38"></a>    <span class="cf">for</span>(iage <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_ages){</span>
<span id="cb42-39"><a href="design-of-ckmr-experiments.html#cb42-39"></a>      N_samp_by[iyr<span class="op">-</span>iage<span class="op">+</span><span class="dv">1</span>]=N_samp_by[iyr<span class="op">-</span>iage<span class="op">+</span><span class="dv">1</span>]<span class="op">+</span>N_samp[iyr,iage]</span>
<span id="cb42-40"><a href="design-of-ckmr-experiments.html#cb42-40"></a>    }</span>
<span id="cb42-41"><a href="design-of-ckmr-experiments.html#cb42-41"></a>  }</span>
<span id="cb42-42"><a href="design-of-ckmr-experiments.html#cb42-42"></a>  </span>
<span id="cb42-43"><a href="design-of-ckmr-experiments.html#cb42-43"></a>  <span class="co">#Number of comparisons, probability of matches, expected number of matches</span></span>
<span id="cb42-44"><a href="design-of-ckmr-experiments.html#cb42-44"></a>  <span class="cf">for</span>(iyr <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n_yrs<span class="dv">-1</span>)){</span>
<span id="cb42-45"><a href="design-of-ckmr-experiments.html#cb42-45"></a>    <span class="cf">for</span>(iyr2 <span class="cf">in</span> (iyr<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>n_yrs){</span>
<span id="cb42-46"><a href="design-of-ckmr-experiments.html#cb42-46"></a>      M[iyr,iyr2]=N_samp_by[iyr]<span class="op">*</span>N_samp_by[iyr2]</span>
<span id="cb42-47"><a href="design-of-ckmr-experiments.html#cb42-47"></a>      age_diff =<span class="st"> </span>iyr2<span class="op">-</span>iyr</span>
<span id="cb42-48"><a href="design-of-ckmr-experiments.html#cb42-48"></a>      HSP_prob =<span class="st"> </span><span class="dv">4</span><span class="op">/</span>N[iyr]<span class="op">*</span>(phiA<span class="op">^</span>age_diff) <span class="co">#nb: there&#39;s some duplication here!</span></span>
<span id="cb42-49"><a href="design-of-ckmr-experiments.html#cb42-49"></a>      EC[iyr,iyr2]=M[iyr,iyr2]<span class="op">*</span>HSP_prob</span>
<span id="cb42-50"><a href="design-of-ckmr-experiments.html#cb42-50"></a>    }</span>
<span id="cb42-51"><a href="design-of-ckmr-experiments.html#cb42-51"></a>  }</span>
<span id="cb42-52"><a href="design-of-ckmr-experiments.html#cb42-52"></a>  </span>
<span id="cb42-53"><a href="design-of-ckmr-experiments.html#cb42-53"></a>  <span class="kw">list</span>(<span class="dt">EC=</span>EC,<span class="dt">M=</span>M)</span>
<span id="cb42-54"><a href="design-of-ckmr-experiments.html#cb42-54"></a>}</span></code></pre></div>
<p>Let’s looks at a few scenarios, including (1) sampling ages proportional to their approximate
abundance in the population, and (2) sampling ages biased towards younger age classes. We’ll sample
20 individuals per year, as might occur in a balanced monitoring program. We’ll generate an expected
number of comparisons and an expected count for each combination of birth years for half-sib comparisons
(omitting same-cohort comparisons).</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="design-of-ckmr-experiments.html#cb43-1"></a>Npy =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">20</span>)</span>
<span id="cb43-2"><a href="design-of-ckmr-experiments.html#cb43-2"></a>Npy[<span class="dv">11</span><span class="op">:</span><span class="dv">20</span>] =<span class="st"> </span><span class="dv">20</span> </span>
<span id="cb43-3"><a href="design-of-ckmr-experiments.html#cb43-3"></a><span class="co"># sampling proportional to what we&#39;d expect with a constant survival probability of 0.92</span></span>
<span id="cb43-4"><a href="design-of-ckmr-experiments.html#cb43-4"></a>age_wts_prop =<span class="st"> </span><span class="fl">0.92</span><span class="op">^</span><span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">5</span>) <span class="co">#since &quot;ages&quot; is 3:8, this needs to consist of 6 weights</span></span>
<span id="cb43-5"><a href="design-of-ckmr-experiments.html#cb43-5"></a>age_wts_young =<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">1</span>)  <span class="co">#5 times more likely to sample &amp; genotype a 3 year old than an 8 year old</span></span>
<span id="cb43-6"><a href="design-of-ckmr-experiments.html#cb43-6"></a>Exp_data_prop =<span class="st"> </span><span class="kw">expected_data</span>(Npy,ylo,yhi,ages,<span class="dt">age_wts=</span>age_wts_prop,N,phiA)</span>
<span id="cb43-7"><a href="design-of-ckmr-experiments.html#cb43-7"></a>Exp_data_young =<span class="st"> </span><span class="kw">expected_data</span>(Npy,ylo,yhi,ages,<span class="dt">age_wts=</span>age_wts_young,N,phiA)</span></code></pre></div>
<p>One thing we can look at right away is the number of kin pairs for the two designs. For the design
with proportional age sampling the number of HSPs is 57.6215; for the design focusing
disproportionally on younger ages, we have 101.9349 HSPs. Why might we have more HSPs when
focusing on younger ages? I believe this is entirely because, on average, we are sampling individuals with birth years that are closer to each other, and potential parents will experience lower cumulative mortality between successive birth events. In fact, this has to be the case given that relative reproductive output is constant in this scenario (stable population) and the only thing that effects HSP probabilities that is different is survival!</p>
</div>
<div id="calculating-expected-variance-under-different-design-scenarios" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.4</span> Calculating expected variance under different design scenarios<a href="design-of-ckmr-experiments.html#calculating-expected-variance-under-different-design-scenarios" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now let’s fit a “correct” model to these data - that is, one in which all assumptions are met. Note
that we don’t actually need to fit a model to do design calculations, but TMB computes variance estimates
and delta method approximations for functions of parameters, so we’ll sacrifice a tiny bit of time
estimating parameters in order to make our lives easier. If we were going to consider a large number of designs (or to do formal optimization of a design using quadratic programming or something) we’d want to revisit this
decision!! So, let’s compile a TMB model, fit a model to data, and look at estimated standard errors of
various quantities.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="design-of-ckmr-experiments.html#cb44-1"></a><span class="co"># compile TMB negative log pseudo-likeihood function</span></span>
<span id="cb44-2"><a href="design-of-ckmr-experiments.html#cb44-2"></a><span class="kw">library</span>(TMB)</span>
<span id="cb44-3"><a href="design-of-ckmr-experiments.html#cb44-3"></a><span class="kw">compile</span>(<span class="st">&quot;TMB/hsp_nll2.cpp&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="design-of-ckmr-experiments.html#cb46-1"></a><span class="co"># format data and specify starting values for parameters</span></span>
<span id="cb46-2"><a href="design-of-ckmr-experiments.html#cb46-2"></a>format_data &lt;-<span class="st"> </span><span class="cf">function</span>(M,EC){</span>
<span id="cb46-3"><a href="design-of-ckmr-experiments.html#cb46-3"></a>  Indices_gt0 =<span class="st"> </span><span class="kw">which</span>(M<span class="op">&gt;</span><span class="dv">0</span>,<span class="dt">arr.ind=</span><span class="ot">TRUE</span>)</span>
<span id="cb46-4"><a href="design-of-ckmr-experiments.html#cb46-4"></a>  Data =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb46-5"><a href="design-of-ckmr-experiments.html#cb46-5"></a>    <span class="dt">n_HSP =</span> EC[Indices_gt0],</span>
<span id="cb46-6"><a href="design-of-ckmr-experiments.html#cb46-6"></a>    <span class="dt">n_UP =</span> M[Indices_gt0]<span class="op">-</span>EC[Indices_gt0],</span>
<span id="cb46-7"><a href="design-of-ckmr-experiments.html#cb46-7"></a>    <span class="dt">born_year =</span> Indices_gt0[,<span class="dv">2</span>],  <span class="co">#for this HSP calc only need birth year of the *younger* animal</span></span>
<span id="cb46-8"><a href="design-of-ckmr-experiments.html#cb46-8"></a>    <span class="dt">age_diff =</span> Indices_gt0[,<span class="dv">2</span>]<span class="op">-</span>Indices_gt0[,<span class="dv">1</span>],</span>
<span id="cb46-9"><a href="design-of-ckmr-experiments.html#cb46-9"></a>    <span class="dt">present_year=</span> <span class="dv">20</span>  <span class="co">#terminal year for abundance estimate</span></span>
<span id="cb46-10"><a href="design-of-ckmr-experiments.html#cb46-10"></a>  )</span>
<span id="cb46-11"><a href="design-of-ckmr-experiments.html#cb46-11"></a>  Data</span>
<span id="cb46-12"><a href="design-of-ckmr-experiments.html#cb46-12"></a>}</span>
<span id="cb46-13"><a href="design-of-ckmr-experiments.html#cb46-13"></a></span>
<span id="cb46-14"><a href="design-of-ckmr-experiments.html#cb46-14"></a>Data_prop =<span class="st"> </span><span class="kw">format_data</span>(<span class="dt">M=</span>Exp_data_prop<span class="op">$</span>M,<span class="dt">EC=</span>Exp_data_prop<span class="op">$</span>EC)</span>
<span id="cb46-15"><a href="design-of-ckmr-experiments.html#cb46-15"></a>Data_young =<span class="st"> </span><span class="kw">format_data</span>(Exp_data_young<span class="op">$</span>M,Exp_data_young<span class="op">$</span>EC)</span>
<span id="cb46-16"><a href="design-of-ckmr-experiments.html#cb46-16"></a>  </span>
<span id="cb46-17"><a href="design-of-ckmr-experiments.html#cb46-17"></a>Parms =<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;N_init&quot;</span> =<span class="st"> </span><span class="dv">1000</span>, <span class="st">&quot;lambda&quot;</span>=<span class="fl">1.0</span>, <span class="dt">phiA=</span><span class="fl">0.94</span>)</span>
<span id="cb46-18"><a href="design-of-ckmr-experiments.html#cb46-18"></a></span>
<span id="cb46-19"><a href="design-of-ckmr-experiments.html#cb46-19"></a><span class="kw">dyn.load</span>(<span class="kw">dynlib</span>(<span class="st">&quot;TMB/hsp_nll2&quot;</span>))</span>
<span id="cb46-20"><a href="design-of-ckmr-experiments.html#cb46-20"></a>obj &lt;-<span class="st"> </span>TMB<span class="op">::</span><span class="kw">MakeADFun</span>(<span class="dt">data =</span> Data_prop, <span class="dt">parameters =</span> Parms, <span class="dt">DLL=</span><span class="st">&quot;hsp_nll2&quot;</span>)</span>
<span id="cb46-21"><a href="design-of-ckmr-experiments.html#cb46-21"></a>Opt =<span class="st"> </span><span class="kw">nlminb</span>(<span class="dt">start=</span>Parms, <span class="dt">objective=</span>obj<span class="op">$</span>fn, <span class="dt">gradient=</span>obj<span class="op">$</span>gr)</span></code></pre></div>
<pre><code>## outer mgc:  698.1</code></pre>
<pre><code>## Warning in nlminb(start = Parms, objective = obj$fn,
## gradient = obj$gr): NA/NaN function evaluation</code></pre>
<pre><code>## outer mgc:  852.9 
## outer mgc:  376.3 
## outer mgc:  156.6 
## outer mgc:  89.72 
## outer mgc:  4.769 
## outer mgc:  2.079 
## outer mgc:  0.04171 
## outer mgc:  0.03488 
## outer mgc:  0.002186 
## outer mgc:  0.0001492</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="design-of-ckmr-experiments.html#cb50-1"></a>SD_report_prop=<span class="kw">sdreport</span>(obj)</span></code></pre></div>
<pre><code>## outer mgc:  0.0001492 
## outer mgc:  0.0005512 
## outer mgc:  0.0008495 
## outer mgc:  8.839 
## outer mgc:  8.957 
## outer mgc:  2.981 
## outer mgc:  2.966 
## outer mgc:  20000</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="design-of-ckmr-experiments.html#cb52-1"></a>obj &lt;-<span class="st"> </span>TMB<span class="op">::</span><span class="kw">MakeADFun</span>(<span class="dt">data =</span> Data_young, <span class="dt">parameters =</span> Parms, <span class="dt">DLL=</span><span class="st">&quot;hsp_nll2&quot;</span>)</span>
<span id="cb52-2"><a href="design-of-ckmr-experiments.html#cb52-2"></a>Opt =<span class="st"> </span><span class="kw">nlminb</span>(<span class="dt">start=</span>Parms, <span class="dt">objective=</span>obj<span class="op">$</span>fn, <span class="dt">gradient=</span>obj<span class="op">$</span>gr)</span></code></pre></div>
<pre><code>## outer mgc:  1241</code></pre>
<pre><code>## Warning in nlminb(start = Parms, objective = obj$fn,
## gradient = obj$gr): NA/NaN function evaluation</code></pre>
<pre><code>## outer mgc:  1682 
## outer mgc:  716.8 
## outer mgc:  297.5 
## outer mgc:  209.9 
## outer mgc:  23.04 
## outer mgc:  32.68 
## outer mgc:  34.65 
## outer mgc:  3.625 
## outer mgc:  0.3037 
## outer mgc:  0.04553 
## outer mgc:  0.001343</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="design-of-ckmr-experiments.html#cb56-1"></a>SD_report_young=<span class="kw">sdreport</span>(obj)</span></code></pre></div>
<pre><code>## outer mgc:  0.001343 
## outer mgc:  0.002588 
## outer mgc:  9.75e-05 
## outer mgc:  15.84 
## outer mgc:  16.05 
## outer mgc:  5.448 
## outer mgc:  5.423 
## outer mgc:  20000</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="design-of-ckmr-experiments.html#cb58-1"></a><span class="co"># </span></span></code></pre></div>
<p>Okay, let’s see what TMB did for us. First let’s check that our estimates are truth - they should be
very close since we’re using expected values.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="design-of-ckmr-experiments.html#cb59-1"></a><span class="kw">print</span>(SD_report_prop<span class="op">$</span>value)</span></code></pre></div>
<pre><code>##     N_init     lambda       phiA     N_last 
##  1.000e+03 -1.864e-08  9.400e-01  1.000e+03</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="design-of-ckmr-experiments.html#cb61-1"></a><span class="kw">print</span>(SD_report_young<span class="op">$</span>value)</span></code></pre></div>
<pre><code>##    N_init    lambda      phiA    N_last 
## 1.000e+03 1.417e-07 9.400e-01 1.000e+03</code></pre>
<p>Well that’s reassuring! How about standard errors?</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="design-of-ckmr-experiments.html#cb63-1"></a><span class="kw">print</span>(SD_report_prop<span class="op">$</span>sd)</span></code></pre></div>
<pre><code>## [1] 616.47723   0.05528   0.05620 588.11186</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="design-of-ckmr-experiments.html#cb65-1"></a><span class="kw">print</span>(SD_report_young<span class="op">$</span>sd)</span></code></pre></div>
<pre><code>## [1] 452.05058   0.04014   0.04057 426.75313</code></pre>
<p>So there is actually a large improvement in estimator performance (across all
parameters) when sampling focuses on the youngest juvenile white sharks!! In fact,
standard errors are 25-30% lower which is pretty substantial. This is
because interbirth intervals are likely to be shorter, increasing the number of HSPs.<br />
Hopefully you can see why conducting this type of analysis is important - it will help
to get the most bang for your buck in deciding what types of samples to target and genotype.</p>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references">
<div id="ref-hillary2018genetic">
<p>Hillary R, Bravington M, Patterson T <em>et al.</em> (2018) Genetic relatedness reveals total population size of white sharks in eastern australia and new zealand. <em>Scientific reports</em>, <strong>8</strong>, 1–9.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/eriqande/tws-ckmr-2022/edit/master/015-design.Rmd",
"text": "Edit"
},
"history": {
"link": "https://github.com/eriqande/tws-ckmr-2022/commits/master/015-design.Rmd",
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["tws-ckmr-2022.pdf", "tws-ckmr-2022.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
