<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Session 3 Simulation and Inference Play with Hillary et al.’s White Shark CKMR example | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA</title>
  <meta name="description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Session 3 Simulation and Inference Play with Hillary et al.’s White Shark CKMR example | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="github-repo" content="yihui/bookdown-crc" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Session 3 Simulation and Inference Play with Hillary et al.’s White Shark CKMR example | Close-kin mark-recapture: theory and practice — Spokane, Washington, USA" />
  
  <meta name="twitter:description" content="A book example for a Chapman &amp; Hall book." />
  

<meta name="author" content="Paul B. Conn and Eric C. Anderson" />


<meta name="date" content="2022-11-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="kin-finding-lab.html"/>
<link rel="next" href="design-of-ckmr-experiments.html"/>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">TWS-CKMR-2022</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Course Overview</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#workshop-schedule"><i class="fa fa-check"></i>Workshop schedule</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#resources"><i class="fa fa-check"></i>Resources</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#setting-computer"><i class="fa fa-check"></i>Setting up your computer</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#step-1.-install-recent-versions-of-r-and-rstudio"><i class="fa fa-check"></i>Step 1. Install recent versions of R and RStudio</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#step-2.-make-sure-that-you-have-git-installed-on-your-system"><i class="fa fa-check"></i>Step 2. Make sure that you have <code>git</code> installed on your system</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#step-3.-get-the-workshop-materials-from-github-with-rstudio"><i class="fa fa-check"></i>Step 3. Get the workshop materials from GitHub with RStudio</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#updating-the-project"><i class="fa fa-check"></i>Updating the project</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#a-word-about-the-renv-package"><i class="fa fa-check"></i>A word about the ‘renv’ package</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#a-word-about-the-tmb-package"><i class="fa fa-check"></i>A word about the TMB package</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html"><i class="fa fa-check"></i><b>1</b> CKMR thought experiments and labs</a>
<ul>
<li class="chapter" data-level="1.1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#afternoon-schedule"><i class="fa fa-check"></i><b>1.1</b> Afternoon schedule</a></li>
<li class="chapter" data-level="1.2" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#thought-experiments"><i class="fa fa-check"></i><b>1.2</b> Thought experiments</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="ckmr-thought-experiments-and-labs.html"><a href="ckmr-thought-experiments-and-labs.html#thought-experiment-1"><i class="fa fa-check"></i><b>1.2.1</b> Thought experiment 1</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html"><i class="fa fa-check"></i><b>2</b> Kin-finding lab</a>
<ul>
<li class="chapter" data-level="2.1" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#looking-at-the-genetic-data-and-pivoting-it"><i class="fa fa-check"></i><b>2.1</b> Looking at the genetic data and pivoting it</a></li>
<li class="chapter" data-level="2.2" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#kin-finding-power-analysis-assuming-no-physical-linkage"><i class="fa fa-check"></i><b>2.2</b> Kin finding power analysis assuming no physical linkage</a></li>
<li class="chapter" data-level="2.3" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#power-for-kin-finding-while-accounting-for-physical-linkage"><i class="fa fa-check"></i><b>2.3</b> Power for kin-finding while accounting for physical linkage</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#make-a-pseudo-genome-for-these-critters"><i class="fa fa-check"></i><b>2.3.1</b> Make a pseudo genome for these critters</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#doing-the-pairwise-comparisons"><i class="fa fa-check"></i><b>2.4</b> Doing the pairwise comparisons</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#make-sure-we-dont-have-duplicate-samples-in-here"><i class="fa fa-check"></i><b>2.4.1</b> Make sure we don’t have duplicate samples in here</a></li>
<li class="chapter" data-level="2.4.2" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#using-the-pairwise_kin_logl_ratios-function"><i class="fa fa-check"></i><b>2.4.2</b> Using the pairwise_kin_logl_ratios() function</a></li>
<li class="chapter" data-level="2.4.3" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#doing-pairwise-comparisons-somewhat-systematically"><i class="fa fa-check"></i><b>2.4.3</b> Doing pairwise comparisons somewhat systematically</a></li>
<li class="chapter" data-level="2.4.4" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#finding-the-po-pairs"><i class="fa fa-check"></i><b>2.4.4</b> Finding the PO pairs</a></li>
<li class="chapter" data-level="2.4.5" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#finding-full-sibling-pairs"><i class="fa fa-check"></i><b>2.4.5</b> Finding full sibling pairs</a></li>
<li class="chapter" data-level="2.4.6" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#looking-for-half-siblings"><i class="fa fa-check"></i><b>2.4.6</b> Looking for half-siblings</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="kin-finding-lab.html"><a href="kin-finding-lab.html#conclusion"><i class="fa fa-check"></i><b>2.5</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><i class="fa fa-check"></i><b>3</b> Simulation and Inference Play with Hillary et al.’s White Shark CKMR example</a>
<ul>
<li class="chapter" data-level="3.1" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#simulating-from-the-inferential-model"><i class="fa fa-check"></i><b>3.1</b> Simulating from the inferential model</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#exponential-growth-model"><i class="fa fa-check"></i><b>3.1.1</b> Exponential growth model</a></li>
<li class="chapter" data-level="3.1.2" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#model-for-kin-pairs"><i class="fa fa-check"></i><b>3.1.2</b> Model for kin pairs</a></li>
<li class="chapter" data-level="3.1.3" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#simulating-from-the-model-for-kin-pairs"><i class="fa fa-check"></i><b>3.1.3</b> Simulating from the model for kin pairs</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#an-r-function-to-compute-the-negative-log-likelihood"><i class="fa fa-check"></i><b>3.2</b> An R function to compute the negative log-likelihood</a></li>
<li class="chapter" data-level="3.3" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#evaluate-the-likelihood-with-tmb"><i class="fa fa-check"></i><b>3.3</b> Evaluate the likelihood with TMB</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#the-general-form-of-a-tmb-c-file"><i class="fa fa-check"></i><b>3.3.1</b> The general form of a TMB C++ file</a></li>
<li class="chapter" data-level="3.3.2" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#compiling-and-linking-tmb-c-code"><i class="fa fa-check"></i><b>3.3.2</b> Compiling and linking TMB C++ code</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#visualize-those-log-likelihood-values"><i class="fa fa-check"></i><b>3.4</b> Visualize those log likelihood values</a></li>
<li class="chapter" data-level="3.5" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#minimizing-the-negative-log-likelihood"><i class="fa fa-check"></i><b>3.5</b> Minimizing the negative log likelihood</a></li>
<li class="chapter" data-level="3.6" data-path="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#sampling-from-the-posterior-with-tmbstan"><i class="fa fa-check"></i><b>3.6</b> Sampling from the Posterior with ‘tmbstan’</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html"><i class="fa fa-check"></i><b>4</b> Design of CKMR Experiments</a>
<ul>
<li class="chapter" data-level="4.1" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#white-shark-design-example"><i class="fa fa-check"></i><b>4.1</b> White shark design example</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#fisher-information-ideas"><i class="fa fa-check"></i><b>4.1.1</b> Fisher information ideas</a></li>
<li class="chapter" data-level="4.1.2" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#calculating-expected-data-under-different-design-scenarios"><i class="fa fa-check"></i><b>4.1.2</b> Calculating expected data under different design scenarios</a></li>
<li class="chapter" data-level="4.1.3" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#calculating-expected-variance-under-different-design-scenarios"><i class="fa fa-check"></i><b>4.1.3</b> Calculating expected variance under different design scenarios</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#bearded-seal-simulation-study"><i class="fa fa-check"></i><b>4.2</b> Bearded seal simulation study</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#setting-up-simulations-population-dynamics"><i class="fa fa-check"></i><b>4.2.1</b> Setting up simulations: Population dynamics</a></li>
<li class="chapter" data-level="4.2.2" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#setting-up-simulations-ckmrpop"><i class="fa fa-check"></i><b>4.2.2</b> Setting up simulations: CKMRpop</a></li>
<li class="chapter" data-level="4.2.3" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#formatting-data-for-estimation"><i class="fa fa-check"></i><b>4.2.3</b> Formatting data for estimation</a></li>
<li class="chapter" data-level="4.2.4" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#fitting-the-ckmr-model"><i class="fa fa-check"></i><b>4.2.4</b> Fitting the CKMR model</a></li>
<li class="chapter" data-level="4.2.5" data-path="design-of-ckmr-experiments.html"><a href="design-of-ckmr-experiments.html#thought-experiment"><i class="fa fa-check"></i><b>4.2.5</b> Thought experiment</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Close-kin mark-recapture: theory and practice — Spokane, Washington, USA</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Session 3</span> Simulation and Inference Play with Hillary et al.’s White Shark CKMR example<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Here we explore the models used in <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> to estimate abundance of white
sharks in Australia. Looking through the paper, I didn’t
find any direct mention of a public repository of data that was used in the paper,
nor any repository of code for their analyses. So, we are just going to simulate
some data here to play with.</p>
<p>While it would be customary to simulate data from a full, age-structured
demographic model, we are, instead, going to simulate kin-pair data from
the model that they use for inference.
One nice thing about simulating from their inference model is that doing so offers a good
way to gain a better understanding of that inference model.</p>
<p>In a later session we will confront data simulated from a forward-in-time, age-structured
population simulation.</p>
<p>The main goal of this session is to explore the properties of a simple
inference model for CKMR, and also to become familiar with the ‘TMB’
and ‘tmbstan’ R packages.</p>
<p>We will start off by loading the R packages that we need for this session.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb58-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb58-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TMB)</span>
<span id="cb58-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmbstan)</span>
<span id="cb58-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinystan)</span></code></pre></div>
<div id="simulating-from-the-inferential-model" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Simulating from the inferential model<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#simulating-from-the-inferential-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="exponential-growth-model" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Exponential growth model<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#exponential-growth-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The authors start with an exponential growth (or decline) model
for the number of adults:
<span class="math display">\[
N_t^A = N_0^Ae^{\lambda t}
\]</span>
where <span class="math inline">\(N_t^A\)</span> is the number of adults at time <span class="math inline">\(t\)</span> and <span class="math inline">\(N_0^A\)</span> is the initial number
of adults (at time <span class="math inline">\(t = 0\)</span>). <span class="math inline">\(\lambda\)</span> is an exponential growth rate.</p>
<p>In practice, time is often translated
so that <span class="math inline">\(t = 0\)</span> corresponds to the birth year of the oldest second-born
member of a pair in the data set.</p>
<p>Here, we define a function to calculate <span class="math inline">\(N_t^A\)</span>:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; calculate the number of adults at time t, given exponential growth or decline</span></span>
<span id="cb59-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param N0 number of adults at time 0</span></span>
<span id="cb59-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param t  time</span></span>
<span id="cb59-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda exponential growth rate parameter</span></span>
<span id="cb59-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb59-5" aria-hidden="true" tabindex="-1"></a>N_adults <span class="ot">&lt;-</span> <span class="cf">function</span>(N0, t, lambda) {</span>
<span id="cb59-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb59-6" aria-hidden="true" tabindex="-1"></a>  N0 <span class="sc">*</span> <span class="fu">exp</span>(lambda <span class="sc">*</span> t)</span>
<span id="cb59-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb59-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s see what that would look like over 60 years, starting from a few different <span class="math inline">\(N_\mathrm{init}\)</span>
values and growing/shrinking at a range of values.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-1" aria-hidden="true" tabindex="-1"></a>A_traj <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb60-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ninit =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1200</span>, <span class="dv">1500</span>, <span class="dv">2000</span>), </span>
<span id="cb60-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.03</span>, <span class="fl">0.03</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb60-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-4" aria-hidden="true" tabindex="-1"></a>)<span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb60-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_adults =</span> <span class="fu">map2</span>(Ninit, lambda, <span class="cf">function</span>(x, y) <span class="fu">N_adults</span>(x, <span class="dv">0</span><span class="sc">:</span><span class="dv">60</span>, y)),</span>
<span id="cb60-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb60-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(num_adults) <span class="sc">%&gt;%</span></span>
<span id="cb60-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ninit, lambda) <span class="sc">%&gt;%</span></span>
<span id="cb60-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">60</span>)</span>
<span id="cb60-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(A_traj, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> num_adults, <span class="at">colour =</span> <span class="fu">factor</span>(lambda))) <span class="sc">+</span></span>
<span id="cb60-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb60-14"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Ninit)</span></code></pre></div>
<p><img src="tws-ckmr-2022_files/figure-html/simN-1.png" width="672" /></p>
</div>
<div id="model-for-kin-pairs" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Model for kin pairs<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#model-for-kin-pairs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We imagine that <span class="math inline">\(n\)</span> young (ages 3 to 8) sharks get sampled each year, and we will assume that
they can be accurately aged. So, for each sampled individual, we know its age.</p>
<p>To make CKMR inference we will investigate the kin-pair relationship (if any) of
each pair of samples, focusing on half-sibling pairs. In order to minimize the effect of
correlated survival of individuals
in shared environments, we will restrict out attention only to pairs of individuals that
were born in different years.</p>
<p>In doing CKMR it is helpful to order each pair of samples
by age, so that each pair includes a <em>first-born member</em> and a
<em>second-born member</em>. We will be using the terms “first-born” and
“second-born” a lot to describe these to members of each pair.</p>
<p>For the purposes of CKMR, here, the most important feature/covariate of
each individual is the year that it was born. We will denote this
by <span class="math inline">\(c_1\)</span> and <span class="math inline">\(c_2\)</span> (think <span class="math inline">\(c\)</span> for cohort) for the first-born and second-born
of each pair, respectively.</p>
<p>We further assume that there is an equal sex ratio amongst the adults,
so that, if there are <span class="math inline">\(N^A_t\)</span> adults at time <span class="math inline">\(t\)</span>, that means there are
<span class="math inline">\(N^A_t/2\)</span> adult males and <span class="math inline">\(N^A_t/2\)</span> adult females at time <span class="math inline">\(t\)</span>.</p>
<p>To formulate a CKMR pseudo-likelihood using half-sibling pairs (as was done by
<span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span>) requires that we derive the probability that a pair of samples
with birth years <span class="math inline">\(c_1\)</span> and <span class="math inline">\(c_2\)</span> are half-siblings. A pair can be half-siblings
either through their mother (maternal half siblings) or through their
father (paternal half siblings). These events are disjoint (though not
necessarily independent—in strictly monogamous species every paternal half sibling
is a maternal half sibling, because sibling is a full sibling), so they can
be thought of as separate “chances” to be a half sibling.</p>
<p>In order for a pair to be maternal half siblings here is what must happen:</p>
<ol style="list-style-type: decimal">
<li>A particular female must give birth to the first-born at time <span class="math inline">\(c_1\)</span>. This
happens with probability 1, because every individual has a mother.</li>
<li>That particular female must survive from year <span class="math inline">\(c_1\)</span> to year <span class="math inline">\(c_2\)</span> so that it could
be a part of the <span class="math inline">\(N_{c_2}^A/2\)</span> females that were available to give birth to
the second-born.</li>
<li>Given that the female survived, the probability that she is the one female
amongst the <span class="math inline">\(N_{c_2}^A/2\)</span> females available to produce offspring born in year
<span class="math inline">\(c_2\)</span> is <span class="math inline">\(\frac{1}{N_{c_2}^A/2} = 2/N_{c_2}^A\)</span>.</li>
</ol>
<p>It is worth noting that in the <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> formulation, (3) has the
probability that it does because it is assumed that every adult female shark has the
same expected relative reproductive output. This is reasonable for sharks whose
fecundity does not depend greatly on body size. It becomes more challenging in
cases where fecundity varies with size or age of the fish, because, in that case,
if the first-born was born to a large, old female that survives to year <span class="math inline">\(c_2\)</span>, then,
since that large female will produce proportionally more offspring at <span class="math inline">\(c_2\)</span>, the
probability of the pair being half-siblings is higher than if they were born to
a young/small female. (This is further complicated by the fact that the age
of the parent of each sample is not typically knowable.)</p>
<p>Also apparent from the above formulation in (2) is that we have to be able to
calculate the probability that a female survives from year <span class="math inline">\(c_1\)</span> to <span class="math inline">\(c_2\)</span>. This
requires that we include in our model an annual adult survival rate. In the case of
<span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span>, this applies to both adult males and adult females and we will
denote it by <span class="math inline">\(\phi_A\)</span>. So the probability that an adult survives from year <span class="math inline">\(c_1\)</span> to
year <span class="math inline">\(c_2\)</span> is <span class="math inline">\(\phi_A^{c_2 - c_1}\)</span>.</p>
<p>From the foregoing, we can derive that the probability that a pair of samples
are maternal half-siblings, given the model in <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> is:
<span class="math display">\[
\phi_A^{c_2 - c_1}\frac{2}{N^A_{c_2}}.
\]</span></p>
<p>It is worth looking at that and keeping in mind that the part that depends on the
population size always depends on the number of adults <em>at time of the
second-born’s birth</em>, and not at the time of the first-born’s birth.</p>
<p>The foregoing were the calculations for being a maternal half sibling, but
each pair also has a separate chance of being a paternal half sibling, which
is the same in this model used by <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span>. Since the events
of being a maternal half sibling and paternal half sibling are disjoint, and
because we assume that we don’t find any full-siblings born in different years,
we can add the maternal and paternal half-sibling probabilities together to
get the overal probability that a pair is a half-sibling pair:
<span class="math display">\[
P(\mathrm{HSP} | c_1, c_2) = \phi_A^{c_2 - c_1}\frac{4}{N^A_{c_2}}.
\]</span></p>
</div>
<div id="simulating-from-the-model-for-kin-pairs" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Simulating from the model for kin pairs<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#simulating-from-the-model-for-kin-pairs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we are going to write a function to simulate sampled pairs from
such a population, and then we will simulate some of them to be half-siblings
according to the probabilities in their inferential model.</p>
<p>We simulate <code>npy</code> samples from years <code>Slo</code> to <code>Shi</code> inclusive. We simulate
the age of each sample by randomly drawing from a vector of weights for each age,
and then we form all pairs of samples and, for each pair, calculate the probability
that it is an HSP or not. Then, from that probability, we simulate whether
or not it is an HSP.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; simulate sampling n sharks a year from year Slo to Shi and return all the sample pairs</span></span>
<span id="cb61-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param npy number of sharks to sample each year (num per year)</span></span>
<span id="cb61-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Slo year to start sampling</span></span>
<span id="cb61-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Shi final year in which to sample</span></span>
<span id="cb61-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ages a vector of the ages at which individuals are sampled</span></span>
<span id="cb61-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param age_wts vector of expected proportion of each age in the sample</span></span>
<span id="cb61-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param N0 initial population size</span></span>
<span id="cb61-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda population growth rate</span></span>
<span id="cb61-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Thi final time to simulate an abundance (must be &gt;= than Shi)</span></span>
<span id="cb61-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param phiA Adult annual survival probability</span></span>
<span id="cb61-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return This returns a list of three components: `pairs`: a tibble of all the pairs,</span></span>
<span id="cb61-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `pair_counts`: a tibble of counts of different pair types of different age differences,</span></span>
<span id="cb61-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; and `samples`: a simple tibble of just the samples, and `N`: a tibble of the</span></span>
<span id="cb61-14"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of adults each year.</span></span>
<span id="cb61-15"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-15" aria-hidden="true" tabindex="-1"></a>simulate_pairs <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb61-16"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">npy =</span> <span class="dv">10</span>,</span>
<span id="cb61-17"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Slo =</span> <span class="dv">20</span>,</span>
<span id="cb61-18"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">Shi =</span> <span class="dv">40</span>,</span>
<span id="cb61-19"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">ages =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">8</span>,</span>
<span id="cb61-20"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_wts =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(ages)),</span>
<span id="cb61-21"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">N0 =</span> <span class="dv">800</span>,</span>
<span id="cb61-22"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fl">0.01</span>,</span>
<span id="cb61-23"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">Thi =</span> <span class="dv">60</span>,</span>
<span id="cb61-24"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">phiA =</span> <span class="fl">0.94</span></span>
<span id="cb61-25"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-25" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb61-26"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-27"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the number of adults each year</span></span>
<span id="cb61-28"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-28" aria-hidden="true" tabindex="-1"></a>  A_traj <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb61-29"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="dv">0</span><span class="sc">:</span>Thi</span>
<span id="cb61-30"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-31"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb61-32"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">num_adults =</span> <span class="fu">N_adults</span>(N0, year, lambda)</span>
<span id="cb61-33"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-34"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-35"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-36"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample npy individuals each year from Slo to Shi, and assign an age</span></span>
<span id="cb61-37"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># to each. From that age and the sampling year, calculate the year it</span></span>
<span id="cb61-38"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># was born in.  Then join on for each sample, the number of adults present</span></span>
<span id="cb61-39"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># at the time it was born.</span></span>
<span id="cb61-40"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-40" aria-hidden="true" tabindex="-1"></a>  samples <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb61-41"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">samp_year =</span> <span class="fu">rep</span>(Slo<span class="sc">:</span>Shi, <span class="at">each=</span>npy)</span>
<span id="cb61-42"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-43"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb61-44"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">sample</span>(ages, <span class="at">size =</span> <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> age_wts),</span>
<span id="cb61-45"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">born_year =</span> samp_year <span class="sc">-</span> age</span>
<span id="cb61-46"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-46" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb61-47"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(A_traj, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;born_year&quot;</span> <span class="ot">=</span> <span class="st">&quot;year&quot;</span>))</span>
<span id="cb61-48"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-49"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-50"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now we form all the possible pairs of those samples</span></span>
<span id="cb61-51"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-51" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(samples)</span>
<span id="cb61-52"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-52" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> samples[<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">each =</span> n),]</span>
<span id="cb61-53"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-53" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">&lt;-</span> samples[<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">times =</span> n),]</span>
<span id="cb61-54"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(s2) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">names</span>(s2), <span class="st">&quot;.old&quot;</span>)</span>
<span id="cb61-55"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-56"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and we keep only the pairs that were born in different years, and we</span></span>
<span id="cb61-57"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforce an ordering such that the first-born is the &quot;old&quot; one that</span></span>
<span id="cb61-58"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># was born in born_year.old (i.e. c1) and the younger one was born in </span></span>
<span id="cb61-59"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># born_year (i.e. c2)</span></span>
<span id="cb61-60"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-60" aria-hidden="true" tabindex="-1"></a>  pairs <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(s1, s2) <span class="sc">%&gt;%</span></span>
<span id="cb61-61"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(born_year.old <span class="sc">&lt;</span> born_year) <span class="sc">%&gt;%</span></span>
<span id="cb61-62"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>( <span class="co"># here we simulate whether each pair is an HSP or not by simulating</span></span>
<span id="cb61-63"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># a Bernoulli random variable for each pair with success probability</span></span>
<span id="cb61-64"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-64" aria-hidden="true" tabindex="-1"></a>            <span class="co"># of P(HSP | c1, c2).</span></span>
<span id="cb61-65"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">age_diff =</span> born_year <span class="sc">-</span> born_year.old,</span>
<span id="cb61-66"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">HSP_prob =</span> (<span class="dv">4</span><span class="sc">/</span>num_adults) <span class="sc">*</span> (phiA <span class="sc">^</span> (born_year <span class="sc">-</span> born_year.old)),</span>
<span id="cb61-67"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">isHSP =</span> <span class="fu">rbernoulli</span>(<span class="fu">n</span>(), <span class="at">p =</span> HSP_prob)</span>
<span id="cb61-68"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-69"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-70"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-71"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># As is often done in CKMR, we can summarize the kin pair data by</span></span>
<span id="cb61-72"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># counting up the number of kin pairs and non-kin pairs in each category</span></span>
<span id="cb61-73"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># defined by different sets of covariates.  In this case different c1 and</span></span>
<span id="cb61-74"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># c2, though it is defined here in terms of c2 and the age difference.</span></span>
<span id="cb61-75"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-75" aria-hidden="true" tabindex="-1"></a>  pair_counts <span class="ot">&lt;-</span> pairs <span class="sc">%&gt;%</span></span>
<span id="cb61-76"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(born_year, age_diff, HSP_prob, isHSP) <span class="sc">%&gt;%</span></span>
<span id="cb61-77"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> isHSP, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> 0L) <span class="sc">%&gt;%</span></span>
<span id="cb61-78"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">n_UP =</span> <span class="st">`</span><span class="at">FALSE</span><span class="st">`</span>, <span class="at">n_HSP =</span> <span class="st">`</span><span class="at">TRUE</span><span class="st">`</span>)</span>
<span id="cb61-79"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-80"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb61-81"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> A_traj,</span>
<span id="cb61-82"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">samples =</span> samples,</span>
<span id="cb61-83"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">pairs =</span> pairs,</span>
<span id="cb61-84"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">pair_counts =</span> pair_counts,</span>
<span id="cb61-85"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">pair_data =</span> pair_counts <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>HSP_prob)</span>
<span id="cb61-86"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-86" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-87"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb61-87" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now that we have done that, let’s simulate some pairs. We will assume that 20 sharks
were sampled per year—that is more than <span class="citation">Hillary <em>et al.</em> (<a href="#ref-hillary2018genetic" role="doc-biblioref">2018</a>)</span> had, I think, but it
makes the likelihood surface a little cleaner, so, since we can simulate whatever we want,
we will simulate an abundance of data:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5</span>)</span>
<span id="cb62-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb62-3" aria-hidden="true" tabindex="-1"></a>sim_vals <span class="ot">&lt;-</span> <span class="fu">simulate_pairs</span>(<span class="at">npy =</span> <span class="dv">20</span>, <span class="at">age_wts =</span> <span class="dv">8</span><span class="sc">:</span><span class="dv">3</span>)</span></code></pre></div>
<p>Take a moment to look at the output. See that it is a list of tibbles. The first
three are:</p>
<ul>
<li><code>N</code>: the population sizes over time,</li>
<li><code>samples</code>: the ages and sampling years of the samples (also it has the number of adults
present at the birth year of each sample)</li>
<li><code>pairs</code>: a tibble with one row for each pair, with the HSP probs calculated, and the
simulated Bernoulli random variable in <code>isHSP</code> saying whether it is a kin pair or not.</li>
</ul>
<p>The remaining two elements of the
list, <code>sim_vals</code>, are the <code>pair_counts</code> which show the number of half-sibling pairs of different types, and also shows the half-sibling pair probability that was used to simulate them:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb63-1" aria-hidden="true" tabindex="-1"></a>sim_vals<span class="sc">$</span>pair_counts</span></code></pre></div>
<pre><code>## # A tibble: 325 × 5
##    born_year age_diff HSP_prob  n_UP n_HSP
##        &lt;int&gt;    &lt;int&gt;    &lt;dbl&gt; &lt;int&gt; &lt;int&gt;
##  1        13        1  0.00413    10     0
##  2        14        1  0.00409    35     0
##  3        14        2  0.00384    14     0
##  4        15        1  0.00405    84     0
##  5        15        2  0.00380    60     0
##  6        15        3  0.00357    24     0
##  7        16        1  0.00401   216     0
##  8        16        2  0.00376   124     2
##  9        16        3  0.00354    90     0
## 10        16        4  0.00333    36     0
## # … with 315 more rows
## # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>In this tibble, <code>n_HSP</code> is the number of half-sibling pairs found in which the second-born was
born in <code>born_year</code> (i.e. <code>born_year</code> = <span class="math inline">\(c_2\)</span> ) and the older member was born <code>age_diff</code> years before (i.e. <span class="math inline">\(c_1\)</span> is <span class="math inline">\(c_2\)</span> - <code>age_diff</code>. As you can see, there
are a lot of categories for which no HSPs are found. That is to be expected—they are pretty rare, and, of course, you expect to see fewer of them if the population is large…that is how CKMR works… The <code>HSP_prob</code> column gives the probability of seeing an HSP of a certain category given
the values of the parameters that were used to simulate the data.</p>
<p>Typically if you had some observed data, you wouldn’t compute the <code>HSP_prob</code> for parameter
values you didn’t know. So, if you had observed data it would look like:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb65-1" aria-hidden="true" tabindex="-1"></a>sim_vals<span class="sc">$</span>pair_data</span></code></pre></div>
<pre><code>## # A tibble: 325 × 4
##    born_year age_diff  n_UP n_HSP
##        &lt;int&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1        13        1    10     0
##  2        14        1    35     0
##  3        14        2    14     0
##  4        15        1    84     0
##  5        15        2    60     0
##  6        15        3    24     0
##  7        16        1   216     0
##  8        16        2   124     2
##  9        16        3    90     0
## 10        16        4    36     0
## # … with 315 more rows
## # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>And the goal from those data would be to estimate the parameters that might have produced these data.</p>
<p>That is what we will be doing shortly, but before that, it is worthwhile to plot the half-sibling pair probabilities, just to look at those.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-1" aria-hidden="true" tabindex="-1"></a>sim_vals<span class="sc">$</span>pairs <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(born_year, age_diff) <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">HSP_prob =</span> <span class="fu">mean</span>(HSP_prob)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> born_year, <span class="at">y =</span> HSP_prob, <span class="at">fill =</span> <span class="fu">factor</span>(age_diff))) <span class="sc">+</span></span>
<span id="cb67-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb67-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;c_2: the birth year of the second-born&quot;</span>) <span class="sc">+</span></span>
<span id="cb67-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Half-sibling probability&quot;</span>) <span class="sc">+</span> </span>
<span id="cb67-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">&quot;age difference,</span><span class="sc">\n</span><span class="st">   c2 - c1&quot;</span>))</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;born_year&#39;. You
## can override using the `.groups` argument.</code></pre>
<p><img src="tws-ckmr-2022_files/figure-html/hsp_prob-1.png" width="672" /></p>
<p><strong>Questions:</strong></p>
<ol style="list-style-type: decimal">
<li>Why do the half-sibling probabilities decline with <span class="math inline">\(c_2\)</span> for any given age difference
between the members of the pair?</li>
<li>For a given value of <span class="math inline">\(c_2\)</span>, why do the half-sibling probabilities decline with
increasing age difference?</li>
</ol>
<hr />
</div>
</div>
<div id="an-r-function-to-compute-the-negative-log-likelihood" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> An R function to compute the negative log-likelihood<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#an-r-function-to-compute-the-negative-log-likelihood" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To estimate the parameters that gave rise to the simulated data, we can start with an R function
to compute the negative log-likelihood—in other words, the probability of our observed data
given values of the parameters, which are:</p>
<ul>
<li>the initial number of adults <span class="math inline">\(N^A_0\)</span>,</li>
<li>the adult population growth rate <span class="math inline">\(\lambda\)</span>,</li>
<li>the probability that an adult survives for a year, <span class="math inline">\(\phi_A\)</span>.</li>
</ul>
<p>The following R function computes that CKMR pseudolikelihood from the <code>pair_counts</code>
tibble in the output from <code>simulate_pairs</code>. Basically, for each category, defined
by <code>born_year</code> (<span class="math inline">\(c_2\)</span>) and an <code>age_diff</code> (such that <span class="math inline">\(c_1 = c_2 - \mathrm{age\_diff}\)</span>),
the number of half-sibling pairs is a Binomial random variable with number of trials
equal to the total number of pairs in that category, and success probability equal to
<span class="math inline">\(P(\mathrm{HSP}|c_1, c_2)\)</span>.</p>
<p>Just for a little review, a Binomial variable with <span class="math inline">\(n\)</span> trials and success probability
<span class="math inline">\(p\)</span> has probability mass function:
<span class="math display">\[
P(x|n,p) = {n \choose x} p^x (1-p)^{n-x}.
\]</span>
The binomial coefficient is a constant with respect to <span class="math inline">\(p\)</span>, so is not relevant
to the likelihood for <span class="math inline">\(p\)</span>, so we can write:
<span class="math display">\[
P(x|n,p) \propto p^x (1-p)^{n-x}.
\]</span>
And if we wanted to write that as a log likelihood, we would have
<span class="math display">\[
\mathcal{L}(p) =  x\log p + (n-x)\log(1 - p)
\]</span>
You will see that in the <code>logl =</code> line in the function below.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Return the negative log likelihood of the parameter values given the data</span></span>
<span id="cb69-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param pars a  vector (N0, lambda, phiA)</span></span>
<span id="cb69-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X a tibble like the pair_counts component of the output list from</span></span>
<span id="cb69-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `simulate_pairs()`.</span></span>
<span id="cb69-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-5" aria-hidden="true" tabindex="-1"></a>hsp_nll <span class="ot">&lt;-</span> <span class="cf">function</span>(pars, X) {</span>
<span id="cb69-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-6" aria-hidden="true" tabindex="-1"></a>  N0 <span class="ot">&lt;-</span> pars[<span class="dv">1</span>]</span>
<span id="cb69-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-7" aria-hidden="true" tabindex="-1"></a>  L <span class="ot">&lt;-</span> pars[<span class="dv">2</span>]  <span class="co"># lambda</span></span>
<span id="cb69-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-8" aria-hidden="true" tabindex="-1"></a>  P <span class="ot">&lt;-</span> pars[<span class="dv">3</span>]  <span class="co"># phi</span></span>
<span id="cb69-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-10" aria-hidden="true" tabindex="-1"></a>  LL <span class="ot">&lt;-</span> X <span class="sc">%&gt;%</span></span>
<span id="cb69-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb69-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">N =</span> N0 <span class="sc">*</span> <span class="fu">exp</span>(L <span class="sc">*</span> born_year),  <span class="co"># number of adults at time of second-born&#39;s birth</span></span>
<span id="cb69-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">hspp =</span> (<span class="dv">4</span> <span class="sc">/</span> N) <span class="sc">*</span> P <span class="sc">^</span> age_diff, <span class="co"># P(HSP | c_1, c_2)</span></span>
<span id="cb69-14"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">logl =</span> <span class="fu">log</span>(hspp) <span class="sc">*</span> n_HSP <span class="sc">+</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> hspp) <span class="sc">*</span> n_UP  <span class="co"># log Binomial probability</span></span>
<span id="cb69-15"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-16"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(LL<span class="sc">$</span>logl)  <span class="co"># negative log likelihood</span></span>
<span id="cb69-17"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb69-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s first compute the negative log-likelihood for the values used in the simulation:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hsp_nll</span>(</span>
<span id="cb70-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="dv">800</span>, <span class="fl">0.01</span>, <span class="fl">0.94</span>),</span>
<span id="cb70-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> sim_vals<span class="sc">$</span>pair_data</span>
<span id="cb70-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb70-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] 1508</code></pre>
<p>Since this is a negative log likelihood, a smaller number is better. We can see that if we
choose parameter values that are far from the true ones we get a bigger (less good) value of the
negative log likelihood.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hsp_nll</span>(</span>
<span id="cb72-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="dv">1800</span>, <span class="fl">0.05</span>, <span class="fl">0.94</span>),</span>
<span id="cb72-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> sim_vals<span class="sc">$</span>pair_data</span>
<span id="cb72-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb72-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] 1752</code></pre>
<p>It is a fun exercise to visualize this log-likelihood surface. But we are not going to do that
with this <code>hsp_nll</code> function, because it is quite slow. Observe how many milliseconds it takes to evaluate the likelihood using the <code>hsp_nll()</code> function:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-1" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb74-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_version =</span> <span class="fu">hsp_nll</span>(</span>
<span id="cb74-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="dv">1800</span>, <span class="fl">0.05</span>, <span class="fl">0.94</span>),</span>
<span id="cb74-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> sim_vals<span class="sc">$</span>pair_data</span>
<span id="cb74-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-5" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb74-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">1000</span></span>
<span id="cb74-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co"># on average, typically more than 2 milliseconds:</span></span>
<span id="cb74-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb74-10" aria-hidden="true" tabindex="-1"></a>mb</span></code></pre></div>
<pre><code>## Unit: milliseconds
##       expr   min    lq  mean median    uq   max neval
##  R_version 2.655 2.947 3.595  3.165 3.695 19.19  1000</code></pre>
<p>In general, straight-up R is a little underpowered for computing these sorts of
likelihoods (because when doing inference from them, you may need to calculate
the likelihood many times) and there are some serious advantages to calculating
them in compiled code using the package TMB. We will do that next.</p>
</div>
<div id="evaluate-the-likelihood-with-tmb" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Evaluate the likelihood with TMB<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#evaluate-the-likelihood-with-tmb" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>‘TMB’ is a package that allows you to write a negative log-likelihood in
compiled C++ code. Compiled code can be orders of magnitude faster than
interpreted R code. Additionally, ‘TMB’ is designed so that if you define
a negative log likelihood in compiled code for it, it will also write and compile
the code to compute the first and second derivatives of this negative log likelihood.</p>
<p>This is called “automatic differentiation” and is quite useful. It relies on the
fact that differentiation is fairly straightforward. For example, if you had a little
bit of C++ code that defined a function <code>f</code> of <code>x</code> like:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb76-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb76-1" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> pow<span class="op">(</span>x<span class="op">,</span> <span class="dv">3</span><span class="op">)</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> pow<span class="op">(</span>x<span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="op">+</span> <span class="dv">8</span> <span class="op">*</span> x</span></code></pre></div>
<p>where <code>pow(x, n)</code> is <span class="math inline">\(x^n\)</span>, then it is pretty easy to see that the code for
the first derivative of that, with respect to <code>x</code>, would be:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb77-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb77-1" aria-hidden="true" tabindex="-1"></a>df_dx <span class="op">=</span> <span class="dv">3</span> <span class="op">*</span> pow<span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> x <span class="op">+</span> <span class="dv">8</span></span></code></pre></div>
<p>And, the second derivative would be something like:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb78-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb78-1" aria-hidden="true" tabindex="-1"></a>d2f_dx2 <span class="op">=</span> <span class="dv">6</span> <span class="op">*</span> x <span class="op">+</span> <span class="dv">6</span></span></code></pre></div>
<p>‘TMB’ uses a library called CppAD to be able to take derivatives of very complex
functions written in C++, even if those functions are defined with <code>for</code> loops,
or even if they, themselves, call other functions. As a consequence it has some
pecularities that must be respected. The most notable is that any variable that
might be involved in the derivative of the function must be defined as a <code>Type</code>
variable. We will see what this means as we go through the code.</p>
<p>The following code is stored in a file <code>TMB/hsp_nll.cpp</code>, relative to the
current working directory, that is already in this repository.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb79-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">// simple half-sibling CKMR with exponential pop growth and known ages</span></span>
<span id="cb79-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;TMB.hpp&gt;</span></span>
<span id="cb79-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-3" aria-hidden="true" tabindex="-1"></a>template<span class="op">&lt;</span>class Type<span class="op">&gt;</span></span>
<span id="cb79-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-4" aria-hidden="true" tabindex="-1"></a>Type objective_function<span class="op">&lt;</span>Type<span class="op">&gt;::</span>operator<span class="op">()</span> <span class="op">()</span></span>
<span id="cb79-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb79-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-6" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR<span class="op">(</span>n_UP<span class="op">);</span></span>
<span id="cb79-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-7" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR<span class="op">(</span>n_HSP<span class="op">);</span></span>
<span id="cb79-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-8" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR<span class="op">(</span>born_year<span class="op">);</span></span>
<span id="cb79-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR<span class="op">(</span>age_diff<span class="op">);</span></span>
<span id="cb79-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-10" aria-hidden="true" tabindex="-1"></a>  PARAMETER<span class="op">(</span>N_init<span class="op">);</span></span>
<span id="cb79-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-11" aria-hidden="true" tabindex="-1"></a>  PARAMETER<span class="op">(</span>lambda<span class="op">);</span></span>
<span id="cb79-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-12" aria-hidden="true" tabindex="-1"></a>  PARAMETER<span class="op">(</span>phiA<span class="op">);</span></span>
<span id="cb79-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-13" aria-hidden="true" tabindex="-1"></a>  ADREPORT<span class="op">(</span>N_init<span class="op">);</span></span>
<span id="cb79-14"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-14" aria-hidden="true" tabindex="-1"></a>  ADREPORT<span class="op">(</span>lambda<span class="op">);</span></span>
<span id="cb79-15"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-15" aria-hidden="true" tabindex="-1"></a>  ADREPORT<span class="op">(</span>phiA<span class="op">);</span></span>
<span id="cb79-16"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-17"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-17" aria-hidden="true" tabindex="-1"></a>  Type N<span class="op">;</span>    <span class="co">// for storing the pop size at the time of the birth of the second-born</span></span>
<span id="cb79-18"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-18" aria-hidden="true" tabindex="-1"></a>  Type hsp<span class="op">;</span>  <span class="co">// for storing the half-sibling pair prob</span></span>
<span id="cb79-19"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-20" aria-hidden="true" tabindex="-1"></a>  Type nll <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb79-21"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-22"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>n_UP<span class="op">.</span>size<span class="op">();</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb79-23"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-23" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> N_init <span class="op">*</span> exp<span class="op">(</span>lambda <span class="op">*</span> born_year<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb79-24"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-24" aria-hidden="true" tabindex="-1"></a>    hsp <span class="op">=</span> <span class="op">(</span><span class="dv">4</span> <span class="op">/</span> N<span class="op">)</span> <span class="op">*</span> pow<span class="op">(</span>phiA<span class="op">,</span> age_diff<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb79-25"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-25" aria-hidden="true" tabindex="-1"></a>    nll <span class="op">-=</span> log<span class="op">(</span>hsp<span class="op">)</span> <span class="op">*</span> n_HSP<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> log<span class="op">(</span><span class="dv">1</span> <span class="op">-</span> hsp<span class="op">)</span> <span class="op">*</span> n_UP<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb79-26"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb79-27"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-28"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> nll<span class="op">;</span></span>
<span id="cb79-29"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb79-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div id="the-general-form-of-a-tmb-c-file" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> The general form of a TMB C++ file<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#the-general-form-of-a-tmb-c-file" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Any time that you define a negative log likelihood function in compiled code
for ‘TMB’, it will look something like this.</p>
<ul>
<li><p>There is always some boilerplate that loads libraries and tells ‘TMB’
that you are compiling an objective function (that you typically will wish
to minimize):</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb80-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;TMB.hpp&gt;</span></span>
<span id="cb80-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb80-2" aria-hidden="true" tabindex="-1"></a>template<span class="op">&lt;</span>class Type<span class="op">&gt;</span></span>
<span id="cb80-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb80-3" aria-hidden="true" tabindex="-1"></a>Type objective_function<span class="op">&lt;</span>Type<span class="op">&gt;::</span>operator<span class="op">()</span> <span class="op">()</span></span>
<span id="cb80-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="op">{...</span></span></code></pre></div></li>
<li><p>Then you tell ‘TMB’ that there will be some <em>data</em> passed to it from R. In
our case we are passing in some vectors of data that are defined with these
<em>macros</em>. The data are considered “fixed”—i.e. they are the what you have
observed.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb81-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb81-1" aria-hidden="true" tabindex="-1"></a>DATA_VECTOR<span class="op">(</span>n_UP<span class="op">);</span></span>
<span id="cb81-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb81-2" aria-hidden="true" tabindex="-1"></a>DATA_VECTOR<span class="op">(</span>n_HSP<span class="op">);</span></span>
<span id="cb81-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb81-3" aria-hidden="true" tabindex="-1"></a>DATA_VECTOR<span class="op">(</span>born_year<span class="op">);</span></span>
<span id="cb81-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb81-4" aria-hidden="true" tabindex="-1"></a>DATA_VECTOR<span class="op">(</span>age_diff<span class="op">);</span>  </span></code></pre></div></li>
<li><p>After that we define some variables that are <em>parameters</em>. These are the things
that we will wish to estimate, and these are also the variables with respect to
which ‘TMB’ will calculate the derivatives using automatic differentiation.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb82-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb82-1" aria-hidden="true" tabindex="-1"></a>PARAMETER<span class="op">(</span>N_init<span class="op">);</span></span>
<span id="cb82-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb82-2" aria-hidden="true" tabindex="-1"></a>PARAMETER<span class="op">(</span>lambda<span class="op">);</span></span>
<span id="cb82-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb82-3" aria-hidden="true" tabindex="-1"></a>PARAMETER<span class="op">(</span>phiA<span class="op">);</span> </span></code></pre></div>
<p>Each one of those is a scalar. <code>N_init</code> here is <code>N0</code>.
That file first must be compiled.</p></li>
<li><p>After that we tell ‘TMB’ which of the parameters we want ‘TMB’ to send information
back to R about, including information about its derivatives.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb83-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb83-1" aria-hidden="true" tabindex="-1"></a>ADREPORT<span class="op">(</span>N_init<span class="op">);</span></span>
<span id="cb83-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb83-2" aria-hidden="true" tabindex="-1"></a>ADREPORT<span class="op">(</span>lambda<span class="op">);</span></span>
<span id="cb83-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb83-3" aria-hidden="true" tabindex="-1"></a>ADREPORT<span class="op">(</span>phiA<span class="op">);</span> </span></code></pre></div>
<p>This is typically used
to obtain point estimate and standard deviations of these parameters via the R function <code>sdreport()</code>.</p></li>
<li><p>Then we start getting into the code itself. Here, when we define
intermediate variables that are part of the function that we want to
auto-differentiate, we cannot simply define them as standard types like
<code>double</code> or <code>integer</code>, but we must define them as type <code>Type</code>:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb84-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb84-1" aria-hidden="true" tabindex="-1"></a>Type N<span class="op">;</span>    <span class="co">// for storing the pop size at the time of the birth of the second-born</span></span>
<span id="cb84-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb84-2" aria-hidden="true" tabindex="-1"></a>Type hsp<span class="op">;</span>  <span class="co">// for storing the half-sibling pair prob</span></span>
<span id="cb84-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb84-4" aria-hidden="true" tabindex="-1"></a>Type nll <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> </span></code></pre></div></li>
<li><p>All that remains then is calculating and returning the objective function. In our case
it is a negative log likelihood that we store in a variable called <code>nll</code>:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb85-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>n_UP<span class="op">.</span>size<span class="op">();</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb85-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb85-2" aria-hidden="true" tabindex="-1"></a>  N <span class="op">=</span> N_init <span class="op">*</span> exp<span class="op">(</span>lambda <span class="op">*</span> born_year<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb85-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb85-3" aria-hidden="true" tabindex="-1"></a>  hsp <span class="op">=</span> <span class="op">(</span><span class="dv">4</span> <span class="op">/</span> N<span class="op">)</span> <span class="op">*</span> pow<span class="op">(</span>phiA<span class="op">,</span> age_diff<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb85-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb85-4" aria-hidden="true" tabindex="-1"></a>  nll <span class="op">-=</span> log<span class="op">(</span>hsp<span class="op">)</span> <span class="op">*</span> n_HSP<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> log<span class="op">(</span><span class="dv">1</span> <span class="op">-</span> hsp<span class="op">)</span> <span class="op">*</span> n_UP<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb85-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb85-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> nll<span class="op">;</span></span></code></pre></div></li>
</ul>
<p>That’s it!</p>
</div>
<div id="compiling-and-linking-tmb-c-code" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Compiling and linking TMB C++ code<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#compiling-and-linking-tmb-c-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In order to use the code in the C++ file, we have to compile it:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compile</span>(<span class="st">&quot;TMB/hsp_nll.cpp&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>And then, in order to get our data into it that function we defined
using ‘TMB’, we need to make a list
with names that are like those in the <code>DATA_VECTOR()</code> parts of the
C++ code:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># then get our data in a list of vectors</span></span>
<span id="cb88-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb88-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> sim_vals<span class="sc">$</span>pair_data <span class="sc">%&gt;%</span></span>
<span id="cb88-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_UP, n_HSP, born_year, age_diff) <span class="sc">%&gt;%</span></span>
<span id="cb88-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>()</span></code></pre></div>
<p>Finally, we can make a list of starting parameter values with
names like those in the <code>PARAMETER()</code> macros of the C++ code:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># and then our starting parameters</span></span>
<span id="cb89-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb89-2" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N_init =</span> <span class="dv">1000</span>, <span class="at">lambda =</span> <span class="fl">0.001</span>, <span class="at">phiA =</span> <span class="fl">0.9</span>)</span></code></pre></div>
<p>Finally, in order to make an AD function (this is a function that can evaluate
the objective function and also return its derivatives) with TMB, we need to link to the library
created when we compiled the file above.</p>
<p>For unknown reasons,on a Mac, ‘TMB’ seems
unable to deal with having the compiled object files in a subdirectory, so, in the
following code chunk we test to see if we are on a Mac, and, if we are, we momentarily
switch to the TMB directory. Otherwise we just run the functions the way we should
be able to.</p>
<p>Additionally, at least on a Mac, ‘TMB’ seems to do a poor job of realizing whether
the compiled library has changed since it last loaded it, so that if you are editing
and recompiling your C++ code, then you need to unload it before loading it again.
So, I tend to always structure my ‘TMB’ code on a Mac like what you seen in the
first part of the <code>if</code> block, below:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">Sys.info</span>()[<span class="st">&quot;sysname&quot;</span>] <span class="sc">==</span> <span class="st">&quot;Darwin&quot;</span>) {</span>
<span id="cb90-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;TMB&quot;</span>)</span>
<span id="cb90-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">try</span>(<span class="fu">dyn.unload</span>(<span class="fu">dynlib</span>(<span class="st">&#39;hsp_nll&#39;</span>)), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dyn.load</span>(<span class="fu">dynlib</span>(<span class="st">&#39;hsp_nll&#39;</span>))</span>
<span id="cb90-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-5" aria-hidden="true" tabindex="-1"></a>  obj <span class="ot">&lt;-</span> TMB<span class="sc">::</span><span class="fu">MakeADFun</span>(<span class="at">data =</span> data, <span class="at">parameters =</span> parameters, <span class="at">DLL=</span><span class="st">&quot;hsp_nll&quot;</span>)</span>
<span id="cb90-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;..&quot;</span>)</span>
<span id="cb90-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb90-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dyn.load</span>(<span class="fu">dynlib</span>(<span class="st">&quot;TMB/hsp_nll&quot;</span>))</span>
<span id="cb90-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-9" aria-hidden="true" tabindex="-1"></a>  obj <span class="ot">&lt;-</span> TMB<span class="sc">::</span><span class="fu">MakeADFun</span>(<span class="at">data =</span> data, <span class="at">parameters =</span> parameters, <span class="at">DLL=</span><span class="st">&quot;hsp_nll&quot;</span>)</span>
<span id="cb90-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb90-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, the AD function/object from TMB is called <code>obj</code>. We might want to see how long
it takes for this compiled version
of the HSP negative log likelihood to be computed:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb91-1" aria-hidden="true" tabindex="-1"></a>mb2 <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb91-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">TMB_version =</span> obj<span class="sc">$</span><span class="fu">fn</span>(<span class="at">x =</span> parameters), <span class="at">times =</span> <span class="dv">1000</span></span>
<span id="cb91-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb91-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb91-4" aria-hidden="true" tabindex="-1"></a>mb2</span></code></pre></div>
<pre><code>## Unit: microseconds
##         expr   min    lq  mean median   uq   max neval
##  TMB_version 34.21 35.02 42.93  35.72 51.2 276.8  1000</code></pre>
<p><strong>Question:</strong> How many times faster, on average, is it to evaluate the
negative log likelihood in compiled code than when using the version we
wrote in R?</p>
<hr />
</div>
</div>
<div id="visualize-those-log-likelihood-values" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Visualize those log likelihood values<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#visualize-those-log-likelihood-values" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we have a fast way to evaluate the negative log likelihood using TMB, let’s
evaluate a lot of them so we can make some contour plots. We will
evaluate the log likelihood over a range of values of the three parameters:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-1" aria-hidden="true" tabindex="-1"></a>LL_tib <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb93-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_init =</span> <span class="fu">seq</span>(<span class="dv">200</span>, <span class="dv">2000</span>, <span class="at">by =</span> <span class="dv">20</span>),</span>
<span id="cb93-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.04</span>, <span class="fl">0.04</span>, <span class="at">by =</span> <span class="fl">0.01</span>),</span>
<span id="cb93-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">phiA =</span> <span class="fu">seq</span>(<span class="fl">0.85</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb93-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb93-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">parameters =</span> <span class="fu">pmap</span>(</span>
<span id="cb93-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.l =</span> <span class="fu">list</span>(<span class="at">a =</span> N_init, <span class="at">b =</span> lambda, <span class="at">c=</span> phiA),</span>
<span id="cb93-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="cf">function</span>(a,b,c) <span class="fu">list</span>(<span class="at">N_init =</span> a, <span class="at">lambda =</span> b, <span class="at">phiA =</span> c)</span>
<span id="cb93-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb93-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb93-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">nll =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb93-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> parameters,</span>
<span id="cb93-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="cf">function</span>(y) obj<span class="sc">$</span><span class="fu">fn</span>(<span class="at">x =</span> y)</span>
<span id="cb93-14"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-15"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb93-15" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>The output looks like this:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb94-1" aria-hidden="true" tabindex="-1"></a>LL_tib</span></code></pre></div>
<pre><code>## # A tibble: 13,104 × 5
##    N_init lambda  phiA parameters         nll
##     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;           &lt;dbl&gt;
##  1    200  -0.04  0.85 &lt;named list [3]&gt; 2818.
##  2    200  -0.04  0.86 &lt;named list [3]&gt; 2921.
##  3    200  -0.04  0.87 &lt;named list [3]&gt; 3034.
##  4    200  -0.04  0.88 &lt;named list [3]&gt; 3158.
##  5    200  -0.04  0.89 &lt;named list [3]&gt; 3295.
##  6    200  -0.04  0.9  &lt;named list [3]&gt; 3446.
##  7    200  -0.04  0.91 &lt;named list [3]&gt; 3613.
##  8    200  -0.04  0.92 &lt;named list [3]&gt; 3797.
##  9    200  -0.04  0.93 &lt;named list [3]&gt; 4000.
## 10    200  -0.04  0.94 &lt;named list [3]&gt; 4226.
## # … with 13,094 more rows
## # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>With all those results, we can make a contour plot, faceted over lambda values
to visualize the negative log-likelihood surface:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-1" aria-hidden="true" tabindex="-1"></a>LL_tib <span class="sc">%&gt;%</span></span>
<span id="cb96-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lambda) <span class="sc">%&gt;%</span></span>
<span id="cb96-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nll =</span> <span class="fu">ifelse</span>(nll <span class="sc">&gt;</span> <span class="fu">min</span>(nll) <span class="sc">+</span> <span class="dv">20</span>, <span class="cn">NA</span>, nll)) <span class="sc">%&gt;%</span></span>
<span id="cb96-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb96-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> N_init, <span class="at">y =</span> phiA, <span class="at">z =</span> nll)) <span class="sc">+</span></span>
<span id="cb96-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_contour</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>lambda) <span class="sc">+</span></span>
<span id="cb96-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb96-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">800</span>, <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb96-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.94</span>, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 9477 rows containing non-finite values
## (stat_contour).</code></pre>
<p><img src="tws-ckmr-2022_files/figure-html/contour-1.png" width="100%" /></p>
<p>I am sure there is a cleaner way of dropping all the contour lines
smaller than a certain value, that doesn’t give us the blocky edge, but
I am not going to bother with it here.</p>
<p>The blue and red lines show where the actual “true” simulated values of <span class="math inline">\(N_\mathrm{init}\)</span> and <span class="math inline">\(\phi_A\)</span> are, respectively.
Recall that the true value of <span class="math inline">\(\lambda\)</span> is 0.01. And see on that facet that the true
values of <span class="math inline">\(N_\mathrm{init}\)</span> and <span class="math inline">\(\phi_A\)</span> are near the top of the likelihood (or the
bottom of the negative log likelihood, if you prefer to think of it that way).</p>
<p>We see that with this much data, and whilst assuming the correct growth rate, the abundance
and the adult survival are estimated quite accurately.</p>
<p>The question remains, however, of how much information there is about <span class="math inline">\(\lambda\)</span>. Can we
estimate that well?</p>
</div>
<div id="minimizing-the-negative-log-likelihood" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Minimizing the negative log likelihood<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#minimizing-the-negative-log-likelihood" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The standard way to minimize the negative log likelihood is to
hand of the objective function to one of R’s standard optimizers.</p>
<p>The <code>nlminb()</code> function seems to work well. We give it some starting
values, the objective function, and its first and second derivates (the
gradient and Hessian, respectively). We will try it with the starting
values in <code>parameters</code>:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb98-1" aria-hidden="true" tabindex="-1"></a>nlm_min <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(</span>
<span id="cb98-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">start =</span> parameters, </span>
<span id="cb98-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> obj<span class="sc">$</span>fn, </span>
<span id="cb98-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">gradient =</span> obj<span class="sc">$</span>gr, </span>
<span id="cb98-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">hessian =</span> obj<span class="sc">$</span>he</span>
<span id="cb98-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb98-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## outer mgc:  1472 
## outer mgc:  312.3 
## outer mgc:  8.777 
## outer mgc:  0.007972 
## outer mgc:  23.4 
## outer mgc:  28.16 
## outer mgc:  34.69 
## outer mgc:  0.6566 
## outer mgc:  0.01179 
## outer mgc:  1.222e-08</code></pre>
<p>And here is the result:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb100-1" aria-hidden="true" tabindex="-1"></a>nlm_min</span></code></pre></div>
<pre><code>## $par
##    N_init    lambda      phiA 
## 7.365e+02 7.829e-03 9.258e-01 
## 
## $objective
## [1] 1507
## 
## $convergence
## [1] 0
## 
## $iterations
## [1] 9
## 
## $evaluations
## function gradient 
##       17       10 
## 
## $message
## [1] &quot;relative convergence (4)&quot;</code></pre>
<p>That is pretty close to the true values that we simulated the data at: <span class="math inline">\(N_0 = 800\)</span>, <span class="math inline">\(\lambda = 0.01\)</span>, <span class="math inline">\(\phi_A = 0.94\)</span>.</p>
<p><strong>Exercise:</strong></p>
<p>Repeat the optimization starting from different values of the parameters
and ensure that you get the same maximum likelihood values.</p>
<hr />
<p>Just for fun, let’s look at those points on the likelihood surface.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluate at a lot of points to get the surface</span></span>
<span id="cb102-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-2" aria-hidden="true" tabindex="-1"></a>LL_tib2 <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb102-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_init =</span> <span class="fu">seq</span>(<span class="dv">200</span>, <span class="dv">2000</span>, <span class="at">by =</span> <span class="dv">20</span>),</span>
<span id="cb102-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fl">0.007829</span>,</span>
<span id="cb102-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">phiA =</span> <span class="fu">seq</span>(<span class="fl">0.85</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb102-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb102-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">parameters =</span> <span class="fu">pmap</span>(</span>
<span id="cb102-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.l =</span> <span class="fu">list</span>(<span class="at">a =</span> N_init, <span class="at">b =</span> lambda, <span class="at">c=</span> phiA),</span>
<span id="cb102-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="cf">function</span>(a,b,c) <span class="fu">list</span>(<span class="at">N_init =</span> a, <span class="at">lambda =</span> b, <span class="at">phiA =</span> c)</span>
<span id="cb102-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-10" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb102-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">nll =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb102-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> parameters,</span>
<span id="cb102-14"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="cf">function</span>(y) obj<span class="sc">$</span><span class="fu">fn</span>(<span class="at">x =</span> y)</span>
<span id="cb102-15"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb102-16"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb102-17"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-18"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-19"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(LL_tib2, <span class="fu">aes</span>(<span class="at">x =</span> N_init, <span class="at">y =</span> phiA, <span class="at">z =</span> nll)) <span class="sc">+</span></span>
<span id="cb102-20"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_contour</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-21"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-22"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>lambda) <span class="sc">+</span></span>
<span id="cb102-23"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb102-24"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">800</span>, <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-25"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.94</span>, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-26"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb102-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">&quot;point&quot;</span>, <span class="at">x =</span> nlm_min<span class="sc">$</span>par[<span class="st">&quot;N_init&quot;</span>], <span class="at">y =</span> nlm_min<span class="sc">$</span>par[<span class="st">&quot;phiA&quot;</span>], <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">&quot;gold&quot;</span>, <span class="at">size =</span> <span class="dv">5</span>)</span></code></pre></div>
<p><img src="tws-ckmr-2022_files/figure-html/unnamed-chunk-50-1.png" width="672" />
The gold “x” marks the MLE.</p>
<p>From these estimates, we can calculate the MLEs of the population sizes
each year, and compare them to the true, simulated values:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-1" aria-hidden="true" tabindex="-1"></a>mleNs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb103-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">60</span>,</span>
<span id="cb103-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_adults =</span> <span class="fu">N_adults</span>(</span>
<span id="cb103-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">N0 =</span> nlm_min<span class="sc">$</span>par[<span class="st">&quot;N_init&quot;</span>], </span>
<span id="cb103-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">t =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">60</span>,</span>
<span id="cb103-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> nlm_min<span class="sc">$</span>par[<span class="st">&quot;lambda&quot;</span>]</span>
<span id="cb103-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb103-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb103-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> num_adults)) <span class="sc">+</span></span>
<span id="cb103-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> sim_vals<span class="sc">$</span>N) <span class="sc">+</span></span>
<span id="cb103-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> sim_vals<span class="sc">$</span>N) <span class="sc">+</span></span>
<span id="cb103-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb103-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> mleNs, <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">&quot;gold&quot;</span>)</span></code></pre></div>
<p><img src="tws-ckmr-2022_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
<p>OK, that is not a perfect fit. We could put confidence intervals around those figures, and
in the next session with Paul, we will see how to get a standard deviation report out of
the TMB. However, I lean toward the Bayesian side of things so, we will use our remaining time
here to show how easy it is to sample from the posterior distribution given a model written
in C++ and compiled by TMB.</p>
<p>Before we proceed to that, let’s also mention one thing: often when formulating
models of this sort, it will be advantageous to transform the variables so that
they respect their bounds. For example, given the formulation above, it is entirely
possible that the maximum likelihood could be found at a value of <span class="math inline">\(\phi_A &gt; 1\)</span>.<br />
So, it is sometimes helpful to parameterize the model differently. We didn’t do that
here because it makes it a bit harder to visualize and interpret the likelihood surfaces.</p>
</div>
<div id="sampling-from-the-posterior-with-tmbstan" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> Sampling from the Posterior with ‘tmbstan’<a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#sampling-from-the-posterior-with-tmbstan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>One very nice feature of using the ‘TMB’ package is that we can plug our
compiled TMB object directly into the ‘rstan’ package
for doing Bayesian inference by sampling from the posterior distribution
implied by the negative log likelihood using No-U-turn MCMC sampling. We do this with
the ‘tmbstan’ package, which lets the compiled TMB object interface directory with
the ‘rstan’ package. The result is simply awesome!</p>
<p>For those who haven’t run across No-U-turn MCMC sampling, it is a special case
of <em>Hamiltonian Monte Carlo</em>. This is a type of Monte Carlo sampling that grew
out of complex notions from differential geometry. The idea is that one can use
the gradient and Hessian of a posterior surface to design an MCMC sampler that more
efficiently samples from that posterior. An outstanding introduction is
available on arXiv: <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;ved=2ahUKEwjvw8iwto37AhV-ATQIHXDZCMUQFnoECCMQAQ&amp;url=https%3A%2F%2Farxiv.org%2Fpdf%2F1701.02434&amp;usg=AOvVaw2qtxGkdm18VhFtrCVopq8G">Betancourt: A Conceptual Introduction to Hamiltonian
Monte Carlo</a>.</p>
<p>Note that we sort of need to impose some bounds on the parameters. Otherwise,
as one might expect seeing the contour plots of the likelihood surfaces, we can
get estimated survival parameters exceeding 1.0, which just doesn’t make sense.
This is one particularly nice feature of using the TMB object in a Bayesian context—it
seems easier to impose these sorts of parameter bounds, than when using the TMB
object to maximize the likelihood.</p>
<p>For some reason that I don’t fully understand, we have to remake the TMB AD function before
we run the following. Something about having used <code>obj$fn</code> to compute the values
of the Neg Log Likelihood, in order to make our pretty contour plots, has gummed things
up. But no worries, we just define it again. Here we have all the extra stuff for
dealing with the Mac’s issues with linking to things in subdirectories.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;TMB&quot;</span>)</span>
<span id="cb104-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dyn.load</span>(<span class="fu">dynlib</span>(<span class="st">&#39;hsp_nll&#39;</span>))</span>
<span id="cb104-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb104-3" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(<span class="at">data =</span> data, <span class="at">parameters =</span> parameters, <span class="at">DLL=</span><span class="st">&quot;hsp_nll&quot;</span>)</span>
<span id="cb104-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;..&quot;</span>)</span></code></pre></div>
<p>Now we can hand that to tmbstan and do a short MCMC run:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmbstan)</span></code></pre></div>
<pre><code>## Loading required package: rstan</code></pre>
<pre><code>## Loading required package: StanHeaders</code></pre>
<pre><code>## rstan (Version 2.21.5, GitRev: 2e1f913d3ca3)</code></pre>
<pre><code>## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)</code></pre>
<pre><code>## 
## Attaching package: &#39;rstan&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     extract</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb112-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">tmbstan</span>(</span>
<span id="cb112-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-3" aria-hidden="true" tabindex="-1"></a>  obj,</span>
<span id="cb112-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains=</span><span class="dv">1</span>,</span>
<span id="cb112-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="at">N_init =</span> <span class="dv">20</span>, <span class="at">lambda =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">phiA =</span> <span class="fl">0.2</span>),</span>
<span id="cb112-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">c</span>(<span class="at">N_init =</span> <span class="cn">Inf</span>, <span class="at">lambda =</span> <span class="fl">0.5</span>, <span class="at">phiA =</span> <span class="fl">1.0</span>), </span>
<span id="cb112-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">7500</span></span>
<span id="cb112-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb112-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;tmb_generic&#39; NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0.000106 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.06 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 7500 [  0%]  (Warmup)
## Chain 1: Iteration:  750 / 7500 [ 10%]  (Warmup)
## Chain 1: Iteration: 1500 / 7500 [ 20%]  (Warmup)
## Chain 1: Iteration: 2250 / 7500 [ 30%]  (Warmup)
## Chain 1: Iteration: 3000 / 7500 [ 40%]  (Warmup)
## Chain 1: Iteration: 3750 / 7500 [ 50%]  (Warmup)
## Chain 1: Iteration: 3751 / 7500 [ 50%]  (Sampling)
## Chain 1: Iteration: 4500 / 7500 [ 60%]  (Sampling)
## Chain 1: Iteration: 5250 / 7500 [ 70%]  (Sampling)
## Chain 1: Iteration: 6000 / 7500 [ 80%]  (Sampling)
## Chain 1: Iteration: 6750 / 7500 [ 90%]  (Sampling)
## Chain 1: Iteration: 7500 / 7500 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 3.89677 seconds (Warm-up)
## Chain 1:                4.26565 seconds (Sampling)
## Chain 1:                8.16243 seconds (Total)
## Chain 1:</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># and here is a summary of the result:</span></span>
<span id="cb114-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb114-2" aria-hidden="true" tabindex="-1"></a>fit</span></code></pre></div>
<pre><code>## Inference for Stan model: hsp_nll.
## 1 chains, each with iter=7500; warmup=3750; thin=1; 
## post-warmup draws per chain=3750, total post-warmup draws=3750.
## 
##            mean se_mean     sd     2.5%      25%
## N_init   915.51   10.08 351.90   416.03   668.15
## lambda     0.00    0.00   0.01    -0.02    -0.01
## phiA       0.93    0.00   0.02     0.89     0.91
## lp__   -1505.94    0.04   1.29 -1509.39 -1506.50
##             50%      75%    97.5% n_eff Rhat
## N_init   860.22  1079.69  1780.87  1218    1
## lambda     0.00     0.01     0.03  1209    1
## phiA       0.92     0.94     0.96  1324    1
## lp__   -1505.61 -1505.00 -1504.50   954    1
## 
## Samples were drawn using NUTS(diag_e) at Fri Oct 21 19:00:41 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>Anyone who has spent months trying to “roll their own” MCMC sampler
will recognize that this was uncharacteristically painless. That is part of
the joy of being able to calculate gradients (with the auto-differentiation
features of TMB) to use those in Hamiltonian Monte Carlo. Also, the maintainers
of Stan, TMB, and tmbstan have done an amazing job!</p>
<p>If you want a really slick visual representation of the results from the
MCMC, you can do:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinystan)</span>
<span id="cb116-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(interactive) {</span>
<span id="cb116-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">launch_shinystan</span>(fit)</span>
<span id="cb116-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb116-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We don’t do that in this Rmarkown document, because you need to be in a
an interactive session for it to work, but, just know that it pops up a
shiny window like this:
<img src="images/shinystan.png" width="100%" /></p>
<p>Also, if we wanted to start our chain from different starting values
and run it in parallel on different cores, we can do that like this, though it
seems the interface to this has changed a little. Try <code>?tmbstan</code> for details.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-1" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb117-2"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> cores)</span>
<span id="cb117-3"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb117-5"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-5" aria-hidden="true" tabindex="-1"></a>init.list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>cores, <span class="cf">function</span>(x) {</span>
<span id="cb117-6"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb117-7"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">N_init =</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">2000</span>, <span class="at">max =</span> <span class="dv">20000</span>),</span>
<span id="cb117-8"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">lambda =</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="fl">0.04</span>, <span class="fl">0.04</span>),</span>
<span id="cb117-9"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">phiA =</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.75</span>, <span class="fl">0.999</span>)</span>
<span id="cb117-10"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-10" aria-hidden="true" tabindex="-1"></a>    )}</span>
<span id="cb117-11"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb117-12"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-13"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-13" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">tmbstan</span>(</span>
<span id="cb117-14"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-14" aria-hidden="true" tabindex="-1"></a>  obj, </span>
<span id="cb117-15"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains=</span>cores, </span>
<span id="cb117-16"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">open_progress=</span><span class="cn">FALSE</span>, </span>
<span id="cb117-17"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">init=</span>init.fn,</span>
<span id="cb117-18"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="at">N_init =</span> <span class="dv">20</span>, <span class="at">lambda =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">phiA =</span> <span class="fl">0.2</span>),</span>
<span id="cb117-19"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">c</span>(<span class="at">N_init =</span> <span class="cn">Inf</span>, <span class="at">lambda =</span> <span class="fl">0.5</span>, <span class="at">phiA =</span> <span class="fl">1.0</span>),</span>
<span id="cb117-20"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">6000</span>,</span>
<span id="cb117-21"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">2000</span></span>
<span id="cb117-22"><a href="simulation-and-inference-play-with-hillary-et-al.s-white-shark-ckmr-example.html#cb117-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>That is remarkably easy and slick. I’m impressed.</p>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" line-spacing="2">
<div id="ref-hillary2018genetic" class="csl-entry">
Hillary R, Bravington M, Patterson T <em>et al.</em> (2018) Genetic relatedness reveals total population size of white sharks in eastern australia and new zealand. <em>Scientific reports</em>, <strong>8</strong>, 1–9.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="kin-finding-lab.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="design-of-ckmr-experiments.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/eriqande/tws-ckmr-2022/edit/master/010-great-white-example.Rmd",
"text": "Edit"
},
"history": {
"link": "https://github.com/eriqande/tws-ckmr-2022/commits/master/010-great-white-example.Rmd",
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["tws-ckmr-2022.pdf", "tws-ckmr-2022.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
